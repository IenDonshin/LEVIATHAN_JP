{% extends "otree/Page.html" %}
{% load otree static %}

{% block global_styles  %}
{{ super() }}
<style>
    :root {
        --ui-bg: #3a3a3a;
        --ui-panel: #2f2f2f;
        --ui-panel-soft: #333333;
        --ui-border: #5a5a5a;
        --ui-text: #f1f1f1;
        --ui-muted: #b9b9b9;
        --ui-accent: #3b74c6;
        --ui-accent-strong: #2f5fa7;
        --ui-warn: #e2b645;
        --ui-warn-strong: #c7972f;
        --ui-danger: #d16a3a;
        --ui-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
        --ui-common-bar-width: 160px;
        --ui-common-bar-height: 30px;
    }

    body {
        background:
            radial-gradient(circle at 10% 10%, rgba(80, 110, 170, 0.15), transparent 55%),
            radial-gradient(circle at 90% 0%, rgba(226, 182, 69, 0.12), transparent 50%),
            linear-gradient(180deg, #3b3b3b 0%, #2f2f2f 100%);
        color: var(--ui-text);
        font-family: "Noto Sans JP", "Hiragino Sans", "Yu Gothic", "Meiryo", sans-serif;
        letter-spacing: 0.01em;
    }

    a {
        color: var(--ui-accent);
    }

    .otree-title {
        display: none;
    }

    .otree-body {
        max-width: 1200px;
        padding: 2.5rem 1.5rem 5rem;
    }

    .otree-form {
        background: transparent;
    }

    .card {
        background: transparent;
        border: none;
    }

    .table {
        color: var(--ui-text);
        background: transparent;
    }

    .table thead th {
        color: var(--ui-muted);
        font-weight: 600;
        border-color: var(--ui-border);
    }

    .table td,
    .table th {
        border-color: var(--ui-border);
        background: transparent;
    }

    .table-striped tbody tr:nth-of-type(odd) {
        background: transparent;
    }

    .btn,
    .otree-next-button {
        background: #d7d7d7;
        color: #2a2a2a;
        border: 1px solid #a0a0a0;
        font-size: 0.78rem;
        padding: 0.35rem 0.9rem;
        border-radius: 2px;
        text-transform: none;
        letter-spacing: 0.02em;
    }

    .btn:hover,
    .otree-next-button:hover {
        background: #f0f0f0;
        color: #1e1e1e;
    }

    .ui-button-ghost {
        background: transparent;
        color: var(--ui-text);
        border: 1px solid var(--ui-border);
    }

    .ui-button-ghost:hover {
        background: rgba(255, 255, 255, 0.08);
        color: var(--ui-text);
    }

    .stage-layout {
        min-height: calc(100vh - 10rem);
        display: flex;
        flex-direction: column;
        gap: 2.5rem;
        animation: fadeUp 0.6s ease both;
    }

    .stage-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 2rem;
        flex-wrap: wrap;
    }

    .stage-title {
        font-size: 1.15rem;
        font-weight: 600;
        text-transform: lowercase;
    }

    .stage-subtitle {
        font-size: 0.85rem;
        color: var(--ui-muted);
        margin-top: 0.4rem;
    }

    .stage-desc {
        max-width: 420px;
        font-size: 0.78rem;
        line-height: 1.6;
        text-align: right;
        color: var(--ui-muted);
    }

    @media (max-width: 768px) {
        .stage-header {
            gap: 1rem;
        }

        .stage-desc {
            text-align: left;
            max-width: 100%;
        }

        .player-grid {
            gap: 1.5rem;
        }

        .player-card,
        .player-card--wide {
            width: 220px;
        }

        .bar-track {
            width: 220px;
        }
    }

    .stage-center {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .stage-stack {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1.5rem;
        width: 100%;
    }

    .stage-footer {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.85rem;
    }

    .action-row {
        display: flex;
        align-items: center;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
    }

    .action-row .btn {
        min-width: 140px;
    }

    .action-row .otree-next-button,
    .action-row .otree-btn-next,
    .action-row button[type="submit"] {
        min-width: 0 !important;
        width: fit-content !important;
        max-width: 100%;
        flex: 0 0 auto !important;
    }

    .player-grid {
        display: flex;
        gap: 2.4rem;
        justify-content: center;
        align-items: flex-end;
        flex-wrap: wrap;
    }

    .player-card {
        width: 140px;
        text-align: center;
        animation: fadeUp 0.6s ease both;
        animation-delay: calc(var(--idx, 0) * 0.06s);
    }

    .player-card--wide {
        width: 260px;
    }

    @keyframes fadeUp {
        from {
            opacity: 0;
            transform: translateY(12px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .player-label {
        font-size: 0.82rem;
        color: var(--ui-muted);
        margin-bottom: 0.7rem;
    }

    .player-label strong {
        color: var(--ui-text);
    }

    .vertical-bar {
        width: 78px;
        height: 190px;
        margin: 0 auto;
        border: 1px solid var(--ui-accent);
        background: var(--ui-panel);
        position: relative;
        display: flex;
        align-items: flex-end;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.04);
    }

    .vertical-bar[data-self="true"] {
        border-color: var(--ui-warn);
    }

    .vertical-bar-fill {
        width: 100%;
        background: var(--ui-accent);
        height: 0%;
        transition: height 0.2s ease-out;
    }

    .vertical-bar-value {
        position: absolute;
        top: 8px;
        left: 0;
        right: 0;
        font-size: 0.82rem;
        font-weight: 600;
        color: var(--ui-text);
    }

    .bar-track {
        position: relative;
        width: 240px;
        height: 36px;
        border: 1px solid var(--ui-border);
        background: var(--ui-panel);
        overflow: hidden;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.04);
    }

    .bar-fill {
        height: 100%;
        width: 0%;
        background: #e6e6e6;
        transition: width 0.2s ease-out;
    }

    .bar-track--warn .bar-fill {
        background: var(--ui-warn);
    }

    .bar-track--blue .bar-fill {
        background: var(--ui-accent);
    }

    .bar-text {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: 600;
        color: #f5f5f5;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    }

    .ui-input,
    .otree-form input[type="number"],
    .otree-form input[type="text"] {
        background: transparent;
        color: var(--ui-text);
        border: 1px solid var(--ui-border);
        text-align: center;
        padding: 0.35rem 0.5rem;
        border-radius: 2px;
        width: 100%;
    }

    .ui-input:focus,
    .otree-form input[type="number"]:focus,
    .otree-form input[type="text"]:focus {
        outline: none;
        border-color: var(--ui-accent);
        box-shadow: 0 0 0 2px rgba(59, 116, 198, 0.2);
    }

    .input-group,
    .input-group-narrow {
        display: flex;
        align-items: stretch;
        gap: 0;
        flex-wrap: nowrap;
    }

    .input-group .form-control,
    .input-group-narrow .form-control {
        background: transparent;
        color: var(--ui-text);
        border: 1px solid var(--ui-border);
        text-align: center;
        min-width: 0;
    }

    .input-group .input-group-text,
    .input-group-narrow .input-group-text {
        background: #d7d7d7;
        color: #1f1f1f;
        border: 1px solid var(--ui-border);
        min-width: 56px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        padding: 0 0.65rem;
    }

    .input-with-slider {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        width: 100%;
    }

    .input-compact {
        flex: 0 0 auto;
        width: 120px;
    }

    .input-compact .form-control,
    .input-compact input[type="number"] {
        width: 100%;
    }

    .ui-slider {
        flex: 1;
        height: 6px;
        appearance: none;
        background: #2a2a2a;
        border: 1px solid var(--ui-border);
        border-radius: 999px;
        cursor: pointer;
    }

    .ui-slider::-webkit-slider-thumb {
        appearance: none;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: var(--ui-accent);
        border: 2px solid #ececec;
    }

    .ui-slider::-moz-range-thumb {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: var(--ui-accent);
        border: 2px solid #ececec;
    }

    .ui-slider::-moz-range-track {
        background: transparent;
    }

    .ui-slider.ui-slider--blue {
        background: #2a2a2a;
    }

    .ui-slider.ui-slider--yellow {
        background: #2a2a2a;
    }

    .input-with-slider--compact {
        gap: 0.4rem;
    }

    .input-with-slider--compact .input-compact {
        width: 72px;
    }

    .ui-slider.ui-slider--compact {
        height: 5px;
    }

    .ui-label {
        font-size: 0.75rem;
        color: var(--ui-muted);
        margin-bottom: 0.35rem;
        display: block;
        text-align: center;
    }

    .matrix-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0.35rem;
    }

    .matrix-table th {
        font-size: 0.75rem;
        color: var(--ui-muted);
        font-weight: 600;
        text-transform: none;
        border: none;
        text-align: center;
        padding-bottom: 0.4rem;
    }

    .matrix-table th:first-child,
    .matrix-table td:first-child {
        text-align: left;
        padding-left: 0.6rem;
    }

    .matrix-table td {
        border: 1px solid var(--ui-warn-strong);
        background: var(--ui-panel);
        text-align: center;
        padding: 0.35rem;
        min-width: 72px;
    }

    .matrix-table.matrix-table--inputs td {
        min-width: 130px;
    }

    .matrix-table td.is-self {
        border-color: var(--ui-border);
        background: var(--ui-panel-soft);
    }

    .matrix-table input {
        background: transparent;
        border: none;
        color: var(--ui-text);
        text-align: center;
        width: 100%;
    }

    .matrix-table .decision-number {
        width: 56px;
        padding: 0.2rem 0.35rem;
        border: 1px solid var(--ui-border);
        border-radius: 2px;
    }

    .matrix-table .ui-slider {
        background: #2a2a2a;
        border: 1px solid var(--ui-border);
    }

    .matrix-input-row {
        display: flex;
        align-items: center;
        gap: 0.45rem;
    }

    .matrix-note {
        font-size: 0.75rem;
        color: var(--ui-muted);
    }

    .summary-chip {
        border: 1px solid var(--ui-border);
        padding: 0.5rem 0.75rem;
        font-size: 0.78rem;
        color: var(--ui-text);
        min-width: 140px;
        text-align: center;
        background: var(--ui-panel);
    }

    .modal-content {
        background: var(--ui-panel);
        color: var(--ui-text);
        border: 1px solid var(--ui-border);
    }

    .modal-header,
    .modal-footer {
        border-color: var(--ui-border);
    }

    .dropout-warning-overlay {
        position: fixed;
        inset: 0;
        background: rgba(12, 12, 12, 0.65);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2100;
        padding: 1.5rem;
    }

    .dropout-warning-overlay.is-active {
        display: flex;
    }

    .dropout-warning-card {
        width: min(460px, 92vw);
        background: var(--ui-panel);
        border: 1px solid var(--ui-border);
        box-shadow: var(--ui-shadow);
        padding: 1.4rem 1.6rem;
        text-align: center;
    }

    .dropout-warning-title {
        font-size: 0.95rem;
        font-weight: 600;
        margin-bottom: 0.35rem;
    }

    .dropout-warning-text {
        font-size: 0.75rem;
        color: var(--ui-muted);
        line-height: 1.4;
        margin-bottom: 0.9rem;
        white-space: nowrap;
    }

    .round-timer-fixed {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1030;
        background: rgba(35, 35, 35, 0.95);
        padding: 0.45rem 1.25rem 0.6rem;
        border-top: 1px solid #5b5b5b;
        box-shadow: 0 -8px 24px rgba(0, 0, 0, 0.25);
    }

    .otree-body {
        padding-bottom: 3.75rem;
    }

    .otree-timer {
        display: none;
    }
</style>
{% endblock %}

{% block body_main %}
{{ super() }}
{% if view.remaining_timeout_seconds() != None %}
<div class="round-timer-fixed" data-timeout-seconds="{{ view.remaining_timeout_seconds() }}">
    <div class="d-flex justify-content-between small text-muted mb-1">
        <span>このページの残り時間</span>
        <span class="round-timer-remaining">--</span>
    </div>
    <div class="progress" style="height: 0.45rem; background: #2a2a2a;">
        <div class="progress-bar round-timer-bar" role="progressbar" style="width: 100%; background: var(--ui-accent);"></div>
    </div>
</div>
{% endif %}
<div id="dropout-warning-overlay" class="dropout-warning-overlay" data-dropout-warning="0">
    <div class="dropout-warning-card">
        <div class="dropout-warning-title">離脱の可能性があります</div>
        <div class="dropout-warning-text">
            操作が確認できないため、自動決定に切り替わります。<br>
            続行する場合は「続行」を押してください。
        </div>
        <button type="button" class="btn" data-dropout-dismiss>続行</button>
    </div>
</div>
{% endblock %}

{% block global_scripts  %}
{{ super() }}
<script>
    function initBarTracks() {
        document.querySelectorAll('.bar-track[data-max]').forEach(function(track) {
            var value = parseFloat(track.dataset.value || '0');
            var max = parseFloat(track.dataset.max || '0');
            if (!Number.isFinite(value)) {
                value = 0;
            }
            if (!Number.isFinite(max) || max <= 0) {
                max = 1;
            }
            var pct = Math.max(0, Math.min(100, (value / max) * 100));
            var fill = track.querySelector('.bar-fill');
            if (fill) {
                fill.style.width = pct.toFixed(2) + '%';
            }
        });
    }

    function initVerticalBars() {
        document.querySelectorAll('.vertical-bar[data-power]').forEach(function(bar) {
            var value = parseFloat(bar.dataset.power || '0');
            if (!Number.isFinite(value)) {
                value = 0;
            }
            var container = bar.closest('[data-power-max]');
            var maxValue = container ? parseFloat(container.dataset.powerMax || '0') : 0;
            if (!Number.isFinite(maxValue) || maxValue <= 0) {
                maxValue = 1;
            }
            var pct = Math.max(0, Math.min(100, (value / maxValue) * 100));
            var fill = bar.querySelector('.vertical-bar-fill');
            if (fill) {
                fill.style.height = pct.toFixed(2) + '%';
            }
        });
    }

    function formatTimerSeconds(totalSeconds) {
        var minutes = Math.floor(totalSeconds / 60);
        var seconds = Math.floor(totalSeconds % 60);
        if (seconds < 10) {
            return minutes + ':0' + seconds;
        }
        return minutes + ':' + seconds;
    }

    function resolveSliderColor(rangeInput) {
        if (!rangeInput) {
            return '#3b74c6';
        }
        if (rangeInput.classList.contains('ui-slider--yellow')) {
            return '#c7972f';
        }
        return '#3b74c6';
    }

    function updateSliderFill(rangeInput) {
        if (!rangeInput) {
            return;
        }
        var min = parseFloat(rangeInput.min || '0');
        var max = parseFloat(rangeInput.max || '0');
        var value = parseFloat(rangeInput.value || '0');
        if (!Number.isFinite(min)) {
            min = 0;
        }
        if (!Number.isFinite(max) || max <= min) {
            max = min + 1;
        }
        if (!Number.isFinite(value)) {
            value = min;
        }
        var pct = ((value - min) / (max - min)) * 100;
        pct = Math.max(0, Math.min(100, pct));
        var color = resolveSliderColor(rangeInput);
        if (rangeInput.classList.contains('ui-slider--vertical-rotated')) {
            rangeInput.style.background = 'linear-gradient(to right, ' + color + ' 0%, ' + color + ' ' + pct.toFixed(2) + '%, #2a2a2a ' + pct.toFixed(2) + '%, #2a2a2a 100%)';
        } else if (rangeInput.classList.contains('ui-slider--vertical')) {
            rangeInput.style.background = 'linear-gradient(to top, ' + color + ' 0%, ' + color + ' ' + pct.toFixed(2) + '%, #2a2a2a ' + pct.toFixed(2) + '%, #2a2a2a 100%)';
        } else {
            rangeInput.style.background = 'linear-gradient(to right, ' + color + ' 0%, ' + color + ' ' + pct.toFixed(2) + '%, #2a2a2a ' + pct.toFixed(2) + '%, #2a2a2a 100%)';
        }
    }
    window.updateSliderFill = updateSliderFill;

    function initInputSliders() {
        document.querySelectorAll('.input-with-slider').forEach(function (wrapper) {
            var numberInput = wrapper.querySelector('input.js-slider-input');
            if (!numberInput) {
                numberInput = wrapper.querySelector('input[type="number"]');
            }
            if (!numberInput) {
                numberInput = wrapper.querySelector('input[type="text"]');
            }
            var rangeInput = wrapper.querySelector('input[type="range"]');
            if (!numberInput || !rangeInput) {
                return;
            }
            var alreadyBound = wrapper.dataset.sliderBound === '1';

            var min = numberInput.getAttribute('min');
            var max = numberInput.getAttribute('max');
            var step = numberInput.getAttribute('step');
            if (min !== null && min !== '') {
                rangeInput.setAttribute('min', min);
            }
            if (max !== null && max !== '') {
                rangeInput.setAttribute('max', max);
            }
            if (step !== null && step !== '') {
                rangeInput.setAttribute('step', step);
            }

            var currentValue = parseFloat(numberInput.value);
            if (Number.isFinite(currentValue)) {
                rangeInput.value = currentValue;
            }
            updateSliderFill(rangeInput);

            if (alreadyBound) {
                return;
            }

            numberInput.addEventListener('input', function () {
                var nextValue = parseFloat(numberInput.value);
                if (Number.isFinite(nextValue)) {
                    rangeInput.value = nextValue;
                }
                updateSliderFill(rangeInput);
            });

            numberInput.addEventListener('change', function () {
                var nextValue = parseFloat(numberInput.value);
                if (Number.isFinite(nextValue)) {
                    rangeInput.value = nextValue;
                }
                updateSliderFill(rangeInput);
            });

            rangeInput.addEventListener('input', function () {
                numberInput.value = rangeInput.value;
                numberInput.dispatchEvent(new Event('input', { bubbles: true }));
                updateSliderFill(rangeInput);
            });

            rangeInput.addEventListener('change', function () {
                numberInput.value = rangeInput.value;
                numberInput.dispatchEvent(new Event('change', { bubbles: true }));
                updateSliderFill(rangeInput);
            });
            wrapper.dataset.sliderBound = '1';
        });
    }
    window.initInputSliders = initInputSliders;

    function initFloatingTimer() {
        var timerEl = document.querySelector('.round-timer-fixed');
        if (!timerEl) {
            return;
        }
        var seconds = parseFloat(timerEl.dataset.timeoutSeconds || '');
        if (!Number.isFinite(seconds) || seconds <= 0) {
            return;
        }
        var barEl = timerEl.querySelector('.round-timer-bar');
        var remainingEl = timerEl.querySelector('.round-timer-remaining');
        var start = Date.now();
        var durationMs = seconds * 1000;

        function tick() {
            var elapsed = Date.now() - start;
            var remainingMs = Math.max(0, durationMs - elapsed);
            var remainingSec = Math.ceil(remainingMs / 1000);
            var pct = (remainingMs / durationMs) * 100;
            if (barEl) {
                barEl.style.width = pct.toFixed(2) + '%';
            }
            if (remainingEl) {
                remainingEl.textContent = formatTimerSeconds(remainingSec);
            }
            if (remainingMs <= 0) {
                clearInterval(intervalId);
            }
        }

        tick();
        var intervalId = setInterval(tick, 200);
    }

    document.addEventListener('DOMContentLoaded', function() {
        initFloatingTimer();
        initInputSliders();
        initBarTracks();
        initVerticalBars();
        if (document && document.documentElement) {
            document.documentElement.setAttribute('lang', 'ja');
        }
        var warningEl = document.getElementById('dropout-warning-overlay');
        var warningActive = false;
        if (window.js_vars && typeof window.js_vars.dropout_warning_active !== 'undefined') {
            warningActive = !!window.js_vars.dropout_warning_active;
        } else if (warningEl) {
            warningActive = warningEl.dataset.dropoutWarning === '1';
        }
        if (warningEl && warningActive) {
            warningEl.classList.add('is-active');
            var dismissBtn = warningEl.querySelector('[data-dropout-dismiss]');
            if (dismissBtn) {
                dismissBtn.addEventListener('click', function () {
                    warningEl.classList.remove('is-active');
                    if (typeof liveSend === 'function') {
                        liveSend({ dismiss_dropout_warning: true });
                    }
                });
            }
        }
        document.querySelectorAll('[required]').forEach(function(el) {
            el.addEventListener('invalid', function () {
                this.setCustomValidity('この項目は必須です。');
            });
            el.addEventListener('input', function () {
                this.setCustomValidity('');
            });
        });

        document.addEventListener('keydown', function(event) {
            if (event.key !== 'Enter') {
                return;
            }

            var active = document.activeElement;
            var tag = active ? active.tagName : '';
            if (active && (
                active.isContentEditable ||
                tag === 'INPUT' ||
                tag === 'TEXTAREA' ||
                tag === 'SELECT'
            )) {
                return;
            }

            var nextButton = document.querySelector('button.otree-next-button');
            if (nextButton && nextButton.disabled) {
                return;
            }

            var form = document.querySelector('form.otree-form');
            if (!form) {
                return;
            }

            event.preventDefault();

            if (typeof form.requestSubmit === 'function') {
                form.requestSubmit();
            } else {
                form.submit();
            }
        });
    });

</script>
{% endblock %}
