{% extends "global/Page.html" %}
{% load otree %}

{% block title %}
    第{{ player.round_number }}ラウンド - 罰威力の移譲
{% endblock %}

{% block content %}
<div class="container">
    <div class="card">
        <div class="card-header {% if is_costly %}bg-warning{% else %}bg-success{% endif %} text-white">
            <h4 class="mb-0">罰威力移譲の決定</h4>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-4">
                    <div class="alert alert-info">
                        <p class="mb-0"><strong>初期罰威力：</strong>
                            <span class="h4">{{ initial_power }}</span>ポイント
                        </p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="alert alert-secondary">
                        <p class="mb-0"><strong>私の貢献：</strong>
                            <span class="h4">{{ my_contribution|floatformat:0 }}</span>
                        </p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="alert alert-secondary">
                        <p class="mb-0"><strong>平均貢献：</strong>
                            <span class="h4">{{ avg_contribution|floatformat:1 }}</span>
                        </p>
                    </div>
                </div>
            </div>
            
            {% if is_costly %}
            <div class="alert alert-warning">
                <strong>注意：</strong>罰威力の移譲には<strong>0.1ポイントにつき1通貨単位</strong>のコストがかかります
            </div>
            {% endif %}
            
            <form method="post">
                <h5>他のプレイヤーへの移譲</h5>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>プレイヤー</th>
                            <th>貢献額</th>
                            <th>移譲する罰威力</th>
                            {% if is_costly %}
                            <th>移譲コスト</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for other in others_data %}
                        <tr>
                            <td>{{ other.player_code }}</td>
                            <td>{{ other.contribution|floatformat:0 }}</td>
                            <td>
                                <input type="number" 
                                       name="transfer_p{{ other.id_in_group }}" 
                                       class="form-control transfer-input"
                                       data-player="{{ other.id_in_group }}"
                                       min="0" 
                                       max="{{ max_transfer }}" 
                                       step="{{ transfer_unit }}"
                                       value="0"
                                       style="width: 120px;">
                            </td>
                            {% if is_costly %}
                            <td class="transfer-cost" id="cost-{{ other.id_in_group }}">0</td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr class="table-warning">
                            <td colspan="2" class="text-right"><strong>移譲総量：</strong></td>
                            <td><strong id="total-transfer">0</strong> / {{ initial_power }}</td>
                            {% if is_costly %}
                            <td><strong id="total-cost">0</strong></td>
                            {% endif %}
                        </tr>
                    </tfoot>
                </table>
                
                <div class="alert alert-danger" id="error-message" style="display: none;">
                </div>
                
                <div class="alert alert-info mt-3">
                    <strong>説明：</strong>
                    <ul class="mb-0">
                        <li>移譲単位：{{ transfer_unit }}ポイント</li>
                        <li>最終罰威力 = {{ initial_power }} - 移譲分 + 受取分</li>
                        {% if is_costly %}
                        <li>移譲コストは貢献利得から差し引かれます</li>
                        {% endif %}
                    </ul>
                </div>
                
                <div class="mt-3">
                    <button type="submit" class="btn btn-primary" id="submit-btn">移譲を確定</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 将Django变量存储在隐藏的data属性中 -->
<div id="transfer-config" style="display:none;"
     data-max-transfer="{{ initial_power }}"
     data-transfer-unit="{{ transfer_unit }}"
     data-is-costly="{{ is_costly|yesno:'true,false' }}"
     data-cost-rate="{{ transfer_cost_rate|default:'0' }}">
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 从隐藏元素获取配置
    var config = document.getElementById('transfer-config');
    var maxTransfer = parseFloat(config.getAttribute('data-max-transfer'));
    var transferUnit = parseFloat(config.getAttribute('data-transfer-unit'));
    var isCostly = config.getAttribute('data-is-costly') === 'true';
    var costRate = parseFloat(config.getAttribute('data-cost-rate'));
    
    // DOM要素
    var inputs = document.querySelectorAll('.transfer-input');
    var totalSpan = document.getElementById('total-transfer');
    var errorMsg = document.getElementById('error-message');
    var submitBtn = document.getElementById('submit-btn');
    var totalCostSpan = document.getElementById('total-cost');
    
    function updateTotals() {
        var totalTransfer = 0;
        var totalCost = 0;
        
        inputs.forEach(function(input) {
            var value = parseFloat(input.value) || 0;
            totalTransfer += value;
            
            if (isCostly) {
                var cost = (value / transferUnit) * costRate;
                totalCost += cost;
                
                var playerId = input.getAttribute('data-player');
                var costCell = document.getElementById('cost-' + playerId);
                if (costCell) {
                    costCell.textContent = cost.toFixed(1);
                }
            }
        });
        
        totalSpan.textContent = totalTransfer.toFixed(1);
        
        if (isCostly && totalCostSpan) {
            totalCostSpan.textContent = totalCost.toFixed(1);
        }
        
        // 验证
        errorMsg.style.display = 'none';
        submitBtn.disabled = false;
        
        if (totalTransfer > maxTransfer) {
            errorMsg.textContent = '移譲総量（' + totalTransfer.toFixed(1) + '）が初期罰威力（' + maxTransfer + '）を超えています';
            errorMsg.style.display = 'block';
            submitBtn.disabled = true;
        }
    }
    
    // 添加事件监听器
    inputs.forEach(function(input) {
        input.addEventListener('input', updateTotals);
        input.addEventListener('change', updateTotals);
    });
    
    // 初始更新
    updateTotals();
});
</script>
{% endblock %}