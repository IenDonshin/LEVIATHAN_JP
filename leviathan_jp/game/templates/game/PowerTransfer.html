{% extends "global/Page.html" %}
{% load otree static %}

{% block title %}
    減点効果移譲フェーズ
{% endblock %}

{% block content %}

<div class="stage-layout">
        <div class="stage-header">
            <div>
                <div class="stage-title">減点効果移譲フェーズ</div>
                <div class="stage-subtitle">第 {{ player.round_number }} ラウンド</div>
            </div>
            <div class="stage-desc">
                減点効果を他の参加者に移譲できます。<br>
                {% if transfer_unit_is_fractional %}入力欄で「1」と入力すると {{ transfer_unit_display }} 単位の移譲になります。{% endif %}<br>
                移譲量の合計は最大 {{ max_transfer_display }} です。<br>
                {% if is_costly %}1単位あたり {{ cost_per_unit_display }} {{ cost_per_unit_label }} のコストが発生します。{% else %}移譲コストはありません。{% endif %}
            </div>
        </div>

        <div class="stage-center">
            <div class="player-grid power-grid" data-power-max="{{ power_max }}">
                {% for member in members_data %}
                <div class="player-card" style="--idx: {{ forloop.counter0 }};">
                    <div class="player-label">
                        {% if member.is_self %}
                            <strong>あなた</strong>
                        {% else %}
                            プレイヤー {{ member.id_in_group }}
                        {% endif %}
                    </div>
                    <div class="vertical-bar"
                         data-power="{% if member.is_self %}{{ current_power }}{% else %}{{ member.power_before_value }}{% endif %}"
                         data-base-power="{% if member.is_self %}{{ current_power }}{% else %}{{ member.power_before_value }}{% endif %}"
                         data-member-id="{{ member.id_in_group }}"
                         data-role="power-bar"
                         {% if member.is_self %}data-self="true"{% endif %}>
                        <div class="vertical-bar-fill"></div>
                        <div class="vertical-bar-base-fill"></div>
                        <div class="vertical-bar-value">{% if member.is_self %}{{ current_power_display }}{% else %}{{ member.power_before_display }}{% endif %}</div>
                        {% if not member.is_self %}
                        <div class="vertical-bar-thumb" data-role="power-thumb"></div>
                        {% endif %}
                        {% if not member.is_self %}
                        <input type="range"
                               class="power-slider ui-slider ui-slider--compact ui-slider--blue ui-slider--vertical"
                               orient="vertical"
                               min="0"
                               max="{{ max_transfer }}"
                               step="{{ transfer_unit }}"
                               value="{{ member.power_before_value }}"
                               data-base-power="{{ member.power_before_value }}"
                               data-target="{{ member.id_in_group }}">
                        {% endif %}
                    </div>
                    <div class="transfer-control">
                        {% if member.is_self %}
                            <div class="transfer-placeholder">譲渡入力なし</div>
                        {% else %}
                            <div class="transfer-input-only">
                                <input type="number"
                                       id="transfer-input-{{ member.id_in_group }}"
                                       name="power_transfer_p{{ member.id_in_group }}"
                                       class="ui-input js-transfer-input decision-number js-slider-input"
                                       min="0"
                                       step="{{ transfer_unit }}"
                                       value="{{ member.initial_transfer_value }}"
                                       placeholder="0.0"
                                       data-target="{{ member.id_in_group }}"
                                       data-target-label="プレイヤー {{ member.id_in_group }}">
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="stage-footer">
            {% if is_costly %}
            <div class="action-row">
                <div class="summary-chip">移譲コスト: <span id="preview-cost">0.0</span> <span id="preview-cost-unit">{{ currency_label_plural }}</span></div>
            </div>
            {% endif %}

            <div class="matrix-note" id="transfer-error" style="color: var(--ui-danger); display: none;"></div>

            <div class="action-row">
                {% next_button %}
            </div>
        </div>
    </div>

<div id="transfer-config" style="display:none"
     data-current-power="{{ current_power }}"
     data-transfer-unit="{{ transfer_unit }}"
     data-cost-per-unit="{{ cost_per_unit }}"
     data-currency-singular="{{ currency_label_singular }}"
     data-currency-plural="{{ currency_label_plural }}"
     data-is-costly="{% if is_costly %}true{% else %}false{% endif %}"
     data-minimum="0"
     data-max-transfer="{{ max_transfer }}"
     data-self-id="{{ player.id_in_group }}">

</div>

<style>
    .power-grid .player-card {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .power-grid {
        --transfer-control-height: 116px;
    }

    .power-grid .transfer-control {
        margin-top: 0.75rem;
        height: var(--transfer-control-height);
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
    }

    .power-grid .transfer-placeholder {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.72rem;
        color: var(--ui-muted);
        text-align: center;
        visibility: hidden;
    }

    .power-grid {
        --power-bar-width: 39px;
        --power-bar-height: 190px;
        --power-thumb-height: 4.5px;
    }

    .power-grid .vertical-bar {
        width: var(--power-bar-width);
        height: var(--power-bar-height);
        position: relative;
        overflow: hidden;
        display: block;
    }

    .power-grid .power-slider {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        writing-mode: bt-lr;
        -webkit-appearance: slider-vertical;
        appearance: slider-vertical;
        background: transparent !important;
        border: none !important;
        z-index: 3;
        margin: 0;
        touch-action: none;
    }

    .power-grid .power-slider::-webkit-slider-runnable-track {
        background: transparent;
        border: none;
    }

    .power-grid .power-slider::-moz-range-track {
        background: transparent;
        border: none;
    }

    .power-grid .power-slider::-webkit-slider-thumb {
        width: 14px;
        height: 26px;
        border-radius: 2px;
        background: transparent;
        border: none;
        opacity: 0;
    }

    .power-grid .power-slider::-moz-range-thumb {
        width: 14px;
        height: 26px;
        border-radius: 2px;
        background: transparent;
        border: none;
        opacity: 0;
    }

    .power-grid .vertical-bar-thumb {
        position: absolute;
        left: 0;
        width: 100%;
        height: var(--power-thumb-height);
        background: rgba(120, 160, 220, 0.45);
        border: 2px solid rgba(236, 236, 236, 0.7);
        border-radius: 2px;
        box-sizing: border-box;
        pointer-events: none;
        z-index: 4;
    }

    .power-grid .vertical-bar-base-fill {
        position: absolute;
        left: 0;
        bottom: 0;
        width: 100%;
        height: 0%;
        background: rgba(40, 75, 135, 1);
        z-index: 1;
    }

    .power-grid .vertical-bar-fill {
        position: absolute;
        left: 0;
        bottom: 0;
        width: 100%;
        background: rgba(120, 160, 220, 1);
        height: 0%;
        transition: none;
        z-index: 2;
    }

    .power-grid .vertical-bar-value {
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        transform: translateY(-50%);
        font-size: 0.82rem;
        font-weight: 600;
        color: var(--ui-text);
        z-index: 5;
    }

    .power-grid .transfer-input-only {
        width: 4.5ch;
        margin-left: auto;
        margin-right: auto;
    }

    .power-grid .transfer-input-only input::placeholder {
        color: var(--ui-muted);
    }
    .power-grid .ui-slider--vertical::-webkit-slider-thumb {
        width: 12px;
        height: 20px;
        border-radius: 2px;
        background: var(--ui-accent);
        border: 2px solid #ececec;
    }

    .power-grid .ui-slider--vertical::-moz-range-thumb {
        width: 12px;
        height: 20px;
        border-radius: 2px;
        background: var(--ui-accent);
        border: 2px solid #ececec;
    }
</style>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    var submitButtonLabel = document.querySelector('button.otree-next-button, button.otree-btn-next');
    if (submitButtonLabel) {
        submitButtonLabel.textContent = '決定';
    }

    var configEl = document.getElementById('transfer-config');
    if (!configEl) {
        return;
    }

    var maxTransfer = parseFloat(configEl.dataset.maxTransfer || '0');
    var currentPower = parseFloat(configEl.dataset.currentPower || '0');
    if (!Number.isFinite(maxTransfer) || maxTransfer <= 0) {
        maxTransfer = currentPower;
    }

    var transferUnit = parseFloat(configEl.dataset.transferUnit || '0.1');
    if (!Number.isFinite(transferUnit) || transferUnit <= 0) {
        transferUnit = 0.1;
    }

    var unitString = transferUnit.toString();
    var decimalPart = unitString.indexOf('.') >= 0 ? unitString.split('.')[1] : '';
    var decimals = decimalPart.length;
    if (decimals === 0 && transferUnit < 1) {
        decimals = 1;
    }
    decimals = Math.min(Math.max(decimals, 1), 4);
    var displayDecimals = Math.max(decimals, 1);

    var isCostly = configEl.dataset.isCostly === 'true';
    var costPerUnit = parseFloat(configEl.dataset.costPerUnit || '0');

    var inputs = Array.from(document.querySelectorAll('.js-transfer-input'));
    var totalOutEl = document.getElementById('total-transfer-out');
    var previewPowerEl = document.getElementById('preview-power');
    var costEl = document.getElementById('preview-cost');
    var costUnitEl = document.getElementById('preview-cost-unit');
    var errorEl = document.getElementById('transfer-error');
    var form = document.querySelector('form.otree-form');
    var submitButton = form ? form.querySelector('button.otree-next-button') : null;
    var selfBar = document.querySelector('.vertical-bar[data-self="true"]');
    var selfValue = selfBar ? selfBar.querySelector('.vertical-bar-value') : null;
    var selfFill = selfBar ? selfBar.querySelector('.vertical-bar-fill') : null;
    var selfId = configEl.dataset.selfId || '';
    var powerMax = 0;
    if (selfBar && selfBar.closest('[data-power-max]')) {
        powerMax = parseFloat(selfBar.closest('[data-power-max]').dataset.powerMax || '0');
    }
    if (!Number.isFinite(powerMax) || powerMax <= 0) {
        powerMax = 1;
    }

    var barsById = {};
    document.querySelectorAll('.vertical-bar[data-member-id]').forEach(function(bar) {
        var id = bar.dataset.memberId || '';
        var base = parseFloat(bar.dataset.basePower || bar.dataset.power || '0');
        if (!Number.isFinite(base)) {
            base = 0;
        }
        barsById[id] = { el: bar, base: base };
    });
    var gainFillColor = 'rgba(120, 160, 220, 1)';
    var reclaimFillColor = gainFillColor;

    function clampToUnit(value) {
        var scaled = Math.round(value / transferUnit) * transferUnit;
        return Math.max(0, parseFloat(scaled.toFixed(decimals + 1)));
    }

    var baselineTransfers = {};
    var baselineTotal = 0;
    inputs.forEach(function (input) {
        var targetId = input.dataset.target || '';
        if (!targetId) {
            return;
        }
        var rawBaseline = parseFloat((input.value || '').trim());
        if (!Number.isFinite(rawBaseline) || rawBaseline < 0) {
            rawBaseline = 0;
        }
        var normalizedBaseline = clampToUnit(rawBaseline);
        baselineTransfers[targetId] = normalizedBaseline;
        baselineTotal += normalizedBaseline;
    });
    baselineTotal = parseFloat(baselineTotal.toFixed(decimals + 1));

    function setBarValue(barEl, value) {
        if (!barEl) {
            return;
        }
        var fillEl = barEl.querySelector('.vertical-bar-fill');
        var baseEl = barEl.querySelector('.vertical-bar-base-fill');
        var valueEl = barEl.querySelector('.vertical-bar-value');
        var thumbEl = barEl.querySelector('.vertical-bar-thumb');
        var isSelfBar = barEl.dataset.self === 'true';
        var pct = Math.max(0, Math.min(100, (value / powerMax) * 100));
        var basePower = parseFloat(barEl.dataset.basePower || '0');
        if (!Number.isFinite(basePower)) {
            basePower = 0;
        }
        var basePct = Math.max(0, Math.min(100, (basePower / powerMax) * 100));
        if (baseEl) {
            baseEl.style.height = basePct.toFixed(2) + '%';
        }
        if (fillEl) {
            if (isSelfBar) {
                var selfDelta = value - basePower;
                fillEl.style.background = gainFillColor;
                if (selfDelta >= 0) {
                    var gainPctSelf = Math.max(0, Math.min(100, (selfDelta / powerMax) * 100));
                    fillEl.style.height = gainPctSelf.toFixed(2) + '%';
                    fillEl.style.bottom = basePct.toFixed(2) + '%';
                } else {
                    var lossPctSelf = Math.max(0, Math.min(100, ((-selfDelta) / powerMax) * 100));
                    var coverBottomPct = Math.max(0, basePct - lossPctSelf);
                    fillEl.style.height = lossPctSelf.toFixed(2) + '%';
                    fillEl.style.bottom = coverBottomPct.toFixed(2) + '%';
                }
            } else {
                var delta = value - basePower;
                if (delta >= 0) {
                    var gainPower = delta;
                    var gainPct = Math.max(0, Math.min(100, (gainPower / powerMax) * 100));
                    fillEl.style.background = gainFillColor;
                    fillEl.style.height = gainPct.toFixed(2) + '%';
                    fillEl.style.bottom = basePct.toFixed(2) + '%';
                } else {
                    var reclaimPower = -delta;
                    var reclaimPct = Math.max(0, Math.min(100, (reclaimPower / powerMax) * 100));
                    fillEl.style.background = reclaimFillColor;
                    fillEl.style.height = reclaimPct.toFixed(2) + '%';
                    fillEl.style.bottom = pct.toFixed(2) + '%';
                }
            }
        }
        if (valueEl) {
            valueEl.textContent = value.toFixed(displayDecimals);
        }
        if (thumbEl) {
            var barHeight = barEl.clientHeight || 0;
            var thumbHeight = thumbEl.offsetHeight || 0;
            var fillPx = barHeight * (pct / 100);
            var bottomPx = Math.max(0, Math.min(barHeight - thumbHeight, fillPx - thumbHeight));
            thumbEl.style.bottom = bottomPx.toFixed(2) + 'px';
        }
    }

    function updateTotals(enforceFormat) {
        var totalOut = 0;
        var transferById = {};

        inputs.forEach(function (input) {
            var rawText = (input.value || '').trim();
            if (transferUnit < 1 && rawText !== '' && rawText.indexOf('.') === -1 && /^\d+$/.test(rawText)) {
                rawText = (parseInt(rawText, 10) * transferUnit).toFixed(displayDecimals);
                input.value = rawText;
            }
            var raw = parseFloat(rawText);
            if (Number.isNaN(raw) || raw < 0) {
                raw = 0;
            }
            var normalized = clampToUnit(raw);
            if (enforceFormat && rawText !== '') {
                input.value = normalized.toFixed(displayDecimals);
            }
            var targetId = input.dataset.target || '';
            if (targetId) {
                transferById[targetId] = normalized;
                var linkedSlider = document.querySelector('.power-slider[data-target="' + targetId + '"]');
                if (linkedSlider) {
                    var baselineTransfer = baselineTransfers[targetId] || 0;
                    var basePower = (barsById[targetId] && barsById[targetId].base) ? barsById[targetId].base : 0;
                    var minAllowed = Math.max(0, basePower - baselineTransfer);
                    var maxAllowed = Math.min(powerMax, basePower + (maxTransfer - baselineTransfer));
                    var projectedValue = basePower + (normalized - baselineTransfer);
                    var cappedValue = Math.max(minAllowed, Math.min(maxAllowed, projectedValue));
                    linkedSlider.min = 0;
                    linkedSlider.max = powerMax;
                    linkedSlider.value = cappedValue;
                    if (window.updateSliderFill) {
                        window.updateSliderFill(linkedSlider);
                    }
                }
            }
            totalOut += normalized;
        });

        totalOut = parseFloat(totalOut.toFixed(decimals + 1));
        var exceeds = totalOut > maxTransfer + 1e-6;

        if (totalOutEl) {
            totalOutEl.textContent = totalOut.toFixed(displayDecimals);
        }

        var remaining = currentPower - (totalOut - baselineTotal);
        if (previewPowerEl) {
            previewPowerEl.textContent = remaining.toFixed(displayDecimals);
        }
        setBarValue(selfBar, remaining);
        Object.keys(barsById).forEach(function(id) {
            var barInfo = barsById[id];
            if (!barInfo || !barInfo.el) {
                return;
            }
            if (id === selfId) {
                return;
            }
            var base = barInfo.base || 0;
            var baselineTransfer = baselineTransfers[id] || 0;
            var delta = transferById[id] || 0;
            var nextValue = base + (delta - baselineTransfer);
            setBarValue(barInfo.el, nextValue);
        });

        if (isCostly && costEl) {
            var units = totalOut / transferUnit;
            var totalCost = units * costPerUnit;
            costEl.textContent = totalCost.toFixed(displayDecimals);
            if (costUnitEl) {
                var singularLabel = configEl.dataset.currencySingular || '';
                var pluralLabel = configEl.dataset.currencyPlural || singularLabel;
                var useSingular = Math.abs(totalCost - 1) < 1e-6;
                costUnitEl.textContent = useSingular ? singularLabel : pluralLabel;
            }
        }

        if (errorEl) {
            if (exceeds) {
                errorEl.textContent = '譲渡量の合計が上限 (' + maxTransfer.toFixed(displayDecimals) + ') を超えています。値を修正してください。';
                errorEl.style.display = 'block';
            } else {
                errorEl.style.display = 'none';
                errorEl.textContent = '';
            }
        }

        if (submitButton) {
            submitButton.disabled = exceeds;
        }
    }

    var transferSliders = Array.from(document.querySelectorAll('.power-slider'));

    inputs.forEach(function (input) {
        input.setAttribute('max', maxTransfer.toString());
        input.addEventListener('keydown', function (event) {
            if (!(transferUnit < 1)) {
                return;
            }
            if (event.ctrlKey || event.metaKey || event.altKey) {
                return;
            }
            if (!/^[0-9]$/.test(event.key)) {
                return;
            }

            var currentText = (input.value || '').trim();
            var isNormalizedFraction = /^0\.\d+$/.test(currentText);

            // When the field already contains normalized text like "0.1",
            // typing a digit should replace it (so "2" -> "0.2"), not append.
            if (isNormalizedFraction) {
                event.preventDefault();
                input.value = event.key;
                updateTotals(false);
            }
        });
        input.addEventListener('focus', function () {
            // Prefilled defaults should be easy to overwrite with one keystroke.
            // Selecting all on focus ensures typing "1" replaces "0.5" -> "1",
            // then the existing normalization logic converts it to "0.1".
            setTimeout(function () {
                if (typeof input.select === 'function') {
                    input.select();
                }
            }, 0);
        });
        input.addEventListener('input', function () { updateTotals(false); });
        input.addEventListener('change', function () { updateTotals(true); });
        input.addEventListener('blur', function () { updateTotals(true); });
    });

    transferSliders.forEach(function (slider) {
        var targetId = slider.dataset.target || '';
        if (targetId) {
            slider.dataset.target = targetId;
        }
        var baselineTransfer = baselineTransfers[targetId] || 0;
        var basePower = (barsById[targetId] && barsById[targetId].base) ? barsById[targetId].base : 0;
        slider.min = 0;
        slider.max = powerMax;
        slider.value = Math.max(0, Math.min(powerMax, basePower));
        if (window.updateSliderFill) {
            window.updateSliderFill(slider);
        }
        slider.addEventListener('input', function () {
            var rawValue = parseFloat(slider.value || basePower);
            var minAllowed = Math.max(0, basePower - baselineTransfer);
            var maxAllowed = Math.min(powerMax, basePower + (maxTransfer - baselineTransfer));
            var clampedValue = Math.min(Math.max(rawValue, minAllowed), maxAllowed);
            slider.value = clampedValue;
            if (window.updateSliderFill) {
                window.updateSliderFill(slider);
            }
            var transferValue = clampToUnit(baselineTransfer + (clampedValue - basePower));
            var linkedInput = document.querySelector('#transfer-input-' + targetId);
            if (linkedInput) {
                linkedInput.value = transferValue.toFixed(displayDecimals);
            }
            updateTotals(false);
        });
        slider.addEventListener('change', function () { updateTotals(true); });
    });

    updateTotals(true);
    if (window.initInputSliders) {
        window.initInputSliders();
    }
});
</script>
{% endblock %}
