{% extends "global/Page.html" %}
{% load otree static %}

{% block title %}
    罰威力移譲ステージ
{% endblock %}

{% block content %}

<div class="stage-layout">
        <div class="stage-header">
            <div>
                <div class="stage-title">移譲ステージ</div>
                <div class="stage-subtitle">第 {{ player.round_number }} ラウンド</div>
            </div>
            <div class="stage-desc">
                罰威力を他の参加者に移譲できます。入力は {{ transfer_unit_display }} 単位です。<br>
                {% if is_costly %}1単位あたり {{ cost_per_unit_display }} {{ currency_label }} のコストが発生します。{% else %}移譲コストはありません。{% endif %}
            </div>
        </div>

        <div class="stage-center">
            <div class="player-grid power-grid" data-power-max="{{ power_max }}">
                {% for member in group.get_players %}
                <div class="player-card" style="--idx: {{ forloop.counter0 }};">
                    <div class="player-label">
                        {% if member.id_in_group == player.id_in_group %}
                            <strong>あなた（プレイヤー {{ member.id_in_group }}）</strong>
                        {% else %}
                            プレイヤー {{ member.id_in_group }}
                        {% endif %}
                    </div>
                    <div class="vertical-bar" data-power="{% if member.id_in_group == player.id_in_group %}{{ current_power }}{% else %}{{ member.punishment_power_before|round(3) }}{% endif %}" data-role="power-bar" {% if member.id_in_group == player.id_in_group %}data-self="true"{% endif %}>
                        <div class="vertical-bar-fill"></div>
                        <div class="vertical-bar-value">{% if member.id_in_group == player.id_in_group %}{{ current_power_display }}{% else %}{{ member.punishment_power_before|round(1) }}{% endif %}</div>
                    </div>
                    <div style="margin-top: 0.75rem;">
                        {% if member.id_in_group == player.id_in_group %}
                            <div class="matrix-note">譲渡入力なし</div>
                        {% else %}
                            <div class="input-with-slider input-with-slider--compact">
                                <div class="input-compact">
                                    <input type="number"
                                           id="transfer-input-{{ member.id_in_group }}"
                                           name="power_transfer_p{{ member.id_in_group }}"
                                           class="ui-input js-transfer-input decision-number"
                                           min="0"
                                           step="{{ transfer_unit }}"
                                           value="0"
                                           data-target="{{ member.id_in_group }}"
                                           data-target-label="プレイヤー {{ member.id_in_group }}">
                                </div>
                                <input type="range"
                                       class="ui-slider ui-slider--compact"
                                       min="0"
                                       max="{{ max_transfer }}"
                                       step="{{ transfer_unit }}"
                                       value="0">
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="stage-footer">
            <div class="action-row">
                <div class="summary-chip">移譲合計: <span id="total-transfer-out">0.0</span></div>
                <div class="summary-chip">暫定の罰威力: <span id="preview-power">{{ current_power_display }}</span></div>
                {% if is_costly %}
                <div class="summary-chip">移譲コスト: <span id="preview-cost">0.0</span> {{ currency_label }}</div>
                {% endif %}
            </div>

            <div class="matrix-note" id="transfer-error" style="color: var(--ui-danger); display: none;"></div>

            <div class="action-row">
                {% next_button %}
            </div>
        </div>
    </div>

<div id="transfer-config" style="display:none"
     data-current-power="{{ current_power }}"
     data-transfer-unit="{{ transfer_unit }}"
     data-cost-per-unit="{{ cost_per_unit }}"
     data-is-costly="{% if is_costly %}true{% else %}false{% endif %}"
     data-minimum="0"
     data-max-transfer="{{ max_transfer }}">

</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    var configEl = document.getElementById('transfer-config');
    if (!configEl) {
        return;
    }

    var maxTransfer = parseFloat(configEl.dataset.maxTransfer || '0');
    var currentPower = parseFloat(configEl.dataset.currentPower || '0');
    if (!Number.isFinite(maxTransfer) || maxTransfer <= 0) {
        maxTransfer = currentPower;
    }

    var transferUnit = parseFloat(configEl.dataset.transferUnit || '0.1');
    if (!Number.isFinite(transferUnit) || transferUnit <= 0) {
        transferUnit = 0.1;
    }

    var unitString = transferUnit.toString();
    var decimalPart = unitString.indexOf('.') >= 0 ? unitString.split('.')[1] : '';
    var decimals = decimalPart.length;
    if (decimals === 0 && transferUnit < 1) {
        decimals = 1;
    }
    decimals = Math.min(Math.max(decimals, 1), 4);
    var displayDecimals = Math.max(decimals, 1);

    var isCostly = configEl.dataset.isCostly === 'true';
    var costPerUnit = parseFloat(configEl.dataset.costPerUnit || '0');

    var inputs = Array.from(document.querySelectorAll('.js-transfer-input'));
    var totalOutEl = document.getElementById('total-transfer-out');
    var previewPowerEl = document.getElementById('preview-power');
    var costEl = document.getElementById('preview-cost');
    var errorEl = document.getElementById('transfer-error');
    var form = document.querySelector('form.otree-form');
    var submitButton = form ? form.querySelector('button.otree-next-button') : null;
    var selfBar = document.querySelector('.vertical-bar[data-self="true"]');
    var selfValue = selfBar ? selfBar.querySelector('.vertical-bar-value') : null;
    var selfFill = selfBar ? selfBar.querySelector('.vertical-bar-fill') : null;
    var powerMax = 0;
    if (selfBar && selfBar.closest('[data-power-max]')) {
        powerMax = parseFloat(selfBar.closest('[data-power-max]').dataset.powerMax || '0');
    }
    if (!Number.isFinite(powerMax) || powerMax <= 0) {
        powerMax = 1;
    }

    function clampToUnit(value) {
        var scaled = Math.round(value / transferUnit) * transferUnit;
        return Math.max(0, parseFloat(scaled.toFixed(decimals + 1)));
    }

    function updateSelfBar(remaining) {
        if (!selfBar || !selfFill || !selfValue) {
            return;
        }
        var pct = Math.max(0, Math.min(100, (remaining / powerMax) * 100));
        selfFill.style.height = pct.toFixed(2) + '%';
        selfValue.textContent = remaining.toFixed(displayDecimals);
    }

    function updateTotals(enforceFormat) {
        var totalOut = 0;

        inputs.forEach(function (input) {
            var rawText = input.value;
            var raw = parseFloat(rawText);
            if (Number.isNaN(raw) || raw < 0) {
                raw = 0;
            }
            var normalized = clampToUnit(raw);
            if (enforceFormat) {
                input.value = normalized.toFixed(displayDecimals);
            }
            totalOut += normalized;
        });

        totalOut = parseFloat(totalOut.toFixed(decimals + 1));
        var exceeds = totalOut > maxTransfer + 1e-6;

        if (totalOutEl) {
            totalOutEl.textContent = totalOut.toFixed(displayDecimals);
        }

        var remaining = currentPower - totalOut;
        if (previewPowerEl) {
            previewPowerEl.textContent = remaining.toFixed(displayDecimals);
        }
        updateSelfBar(remaining);

        if (isCostly && costEl) {
            var units = totalOut / transferUnit;
            var totalCost = units * costPerUnit;
            costEl.textContent = totalCost.toFixed(displayDecimals);
        }

        if (errorEl) {
            if (exceeds) {
                errorEl.textContent = '譲渡量の合計が保有する罰威力 (' + currentPower.toFixed(displayDecimals) + ') を超えています。値を修正してください。';
                errorEl.style.display = 'block';
            } else {
                errorEl.style.display = 'none';
                errorEl.textContent = '';
            }
        }

        if (submitButton) {
            submitButton.disabled = exceeds;
        }
    }

    inputs.forEach(function (input) {
        input.setAttribute('max', maxTransfer.toString());
        input.addEventListener('input', function () { updateTotals(false); });
        input.addEventListener('change', function () { updateTotals(true); });
        input.addEventListener('blur', function () { updateTotals(true); });
    });

    updateTotals(true);
    if (window.initInputSliders) {
        window.initInputSliders();
    }
});
</script>
{% endblock %}
