{% extends "global/Page.html" %}
{% load otree static %}

{% block title %}
    第 {{ player.round_number }} ラウンド：罰威力の移転
{% endblock %}

{% block content %}

<div class="card bg-light mb-3">
    <div class="card-body">
        <h4 class="card-title mb-3">現在の罰威力</h4>
        <div class="table-responsive">
            <table class="table table-sm table-bordered text-center mb-0">
                <thead class="thead-dark">
                    <tr>
                        <th>プレイヤー</th>
                        <th>罰威力</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="table-primary">
                        <td>あなた (プレイヤー {{ player.id_in_group }})</td>
                        <td><strong id="current-power-display">{{ current_power_display }}</strong></td>
                    </tr>
                    {% if players_status %}
                        {% for status in players_status %}
                            {% if not status.is_self %}
                                <tr class="text-muted">
                                    <td>
                                        {% if status.label %}
                                            {{ status.label }}
                                        {% else %}
                                            プレイヤー {{ status.id_in_group }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if status.current_power %}
                                            {{ status.current_power }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </tbody>
            </table>
        </div>
        <p class="mt-3 mb-0 small text-muted">最初の移転ラウンドでは罰威力は 1.0 から開始します。</p>
    </div>
</div>

<form method="post" id="power-transfer-form">
    <div class="card">
        <div class="card-body">
            <h4 class="card-title">罰威力移転の決定</h4>
            <p class="text-muted">各入力欄には 0 以上の数値を {{ transfer_unit }} 刻みで入力してください。</p>

            <div class="table-responsive">
                <table class="table table-bordered text-center" id="transfer-table">
                    <thead class="thead-dark">
                        <tr>
                            <th>プレイヤー</th>
                            <th>移転前の罰威力</th>
                            <th>移転後（暫定）</th>
                            <th>転出量</th>
                            {% for other in group.get_players %}
                                {% if other.id_in_group != player.id_in_group %}
                                    <th>向プレイヤー {{ other.id_in_group }} へ</th>
                                {% endif %}
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="table-primary">
                            <td><strong>あなた (プレイヤー {{ player.id_in_group }})</strong></td>
                            <td><span id="initial-power">{{ current_power_display }}</span></td>
                            <td><span id="remaining-power">{{ current_power_display }}</span></td>
                            <td>- <span id="total-transfer-out">0.0</span></td>
                            {% for other in group.get_players %}
                                {% if other.id_in_group != player.id_in_group %}
                                    <td>
                                        <input type="number"
                                               name="power_transfer_p{{ other.id_in_group }}"
                                               class="form-control form-control-sm js-transfer-input"
                                               min="0"
                                               step="{{ transfer_unit }}"
                                               value="0"
                                               data-target="{{ other.id_in_group }}"
                                               data-target-label="プレイヤー {{ other.id_in_group }}"
                                               aria-label="プレイヤー {{ other.id_in_group }} への罰威力転出量">
                                    </td>
                                {% endif %}
                            {% endfor %}
                        </tr>
                    </tbody>
                </table>
            </div>

            {% if is_costly %}
            <div class="alert alert-warning" role="alert">
                <strong>注意：</strong> {{ transfer_unit_display }} ポイントの移転ごとに <strong>{{ cost_per_unit }}</strong> {{ currency_label }} のコストが発生します。
            </div>
            {% endif %}

            <div class="row">
                <div class="col-md-6 mb-2">
                    <div class="border rounded p-3 bg-light">
                        <div><strong>暫定の罰威力:</strong> <span id="preview-power">{{ current_power_display }}</span></div>
                        <div class="small text-muted">= 移転前の罰威力 - 転出量 + (受取量は待機後に反映されます)</div>
                    </div>
                </div>
                {% if is_costly %}
                <div class="col-md-6 mb-2">
                    <div class="border rounded p-3 bg-light">
                        <div><strong>移転コスト:</strong> <span id="preview-cost">0.0</span> {{ currency_label }}</div>
                        <div class="small text-muted">= 転出単位数 × 単位当たりコスト</div>
                    </div>
                </div>
                {% endif %}
            </div>

            <div class="alert alert-danger mt-3 d-none" id="transfer-error"></div>

            <div class="text-right mt-3">
                {% next_button %}
            </div>
        </div>
    </div>
</form>

<div id="transfer-config" style="display:none"
     data-current-power="{{ current_power }}"
     data-transfer-unit="{{ transfer_unit }}"
     data-cost-per-unit="{{ cost_per_unit }}"
     data-is-costly="{% if is_costly %}true{% else %}false{% endif %}"
     data-minimum="0"
     data-max-transfer="{{ max_transfer }}">

</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    var configEl = document.getElementById('transfer-config');
    if (!configEl) {
        return;
    }

    var maxTransfer = parseFloat(configEl.dataset.maxTransfer || '0');
    var currentPower = parseFloat(configEl.dataset.currentPower || '0');
    if (!Number.isFinite(maxTransfer) || maxTransfer <= 0) {
        maxTransfer = currentPower;
    }

    var transferUnit = parseFloat(configEl.dataset.transferUnit || '0.1');
    if (!Number.isFinite(transferUnit) || transferUnit <= 0) {
        transferUnit = 0.1;
    }

    var unitString = transferUnit.toString();
    var decimalPart = unitString.indexOf('.') >= 0 ? unitString.split('.')[1] : '';
    var decimals = decimalPart.length;
    if (decimals === 0 && transferUnit < 1) {
        decimals = 1;
    }
    decimals = Math.min(Math.max(decimals, 1), 4);
    var displayDecimals = Math.max(decimals, 1);

    var isCostly = configEl.dataset.isCostly === 'true';
    var costPerUnit = parseFloat(configEl.dataset.costPerUnit || '0');

    var inputs = Array.from(document.querySelectorAll('.js-transfer-input'));
    var totalOutEl = document.getElementById('total-transfer-out');
    var remainingEl = document.getElementById('remaining-power');
    var previewPowerEl = document.getElementById('preview-power');
    var costEl = document.getElementById('preview-cost');
    var errorEl = document.getElementById('transfer-error');
    var form = document.getElementById('power-transfer-form');
    var submitButton = form ? form.querySelector('button.otree-next-button') : null;

    function clampToUnit(value) {
        var scaled = Math.round(value / transferUnit) * transferUnit;
        return Math.max(0, parseFloat(scaled.toFixed(decimals + 1)));
    }

    function updateTotals(enforceFormat) {
        var totalOut = 0;

        inputs.forEach(function (input) {
            var rawText = input.value;
            var raw = parseFloat(rawText);
            if (Number.isNaN(raw) || raw < 0) {
                raw = 0;
            }
            var normalized = clampToUnit(raw);
            if (enforceFormat) {
                input.value = normalized.toFixed(displayDecimals);
            }
            totalOut += normalized;
        });

        totalOut = parseFloat(totalOut.toFixed(decimals + 1));
        var exceeds = totalOut > maxTransfer + 1e-6;

        if (totalOutEl) {
            totalOutEl.textContent = totalOut.toFixed(displayDecimals);
        }

        var remaining = currentPower - totalOut;
        if (remainingEl) {
            remainingEl.textContent = remaining.toFixed(displayDecimals);
        }
        if (previewPowerEl) {
            previewPowerEl.textContent = remaining.toFixed(displayDecimals);
        }

        if (isCostly && costEl) {
            var units = totalOut / transferUnit;
            var totalCost = units * costPerUnit;
            costEl.textContent = totalCost.toFixed(displayDecimals);
        }

        if (errorEl) {
            if (exceeds) {
                errorEl.textContent = '転出量の合計が保有する罰威力 (' + currentPower.toFixed(displayDecimals) + ') を超えています。値を修正してください。';
                errorEl.classList.remove('d-none');
            } else {
                errorEl.classList.add('d-none');
                errorEl.textContent = '';
            }
        }

        if (submitButton) {
            submitButton.disabled = exceeds;
        }
    }

    inputs.forEach(function (input) {
        input.addEventListener('input', function () { updateTotals(false); });
        input.addEventListener('change', function () { updateTotals(true); });
        input.addEventListener('blur', function () { updateTotals(true); });
    });

    updateTotals(true);
});
</script>
{% endblock %}
