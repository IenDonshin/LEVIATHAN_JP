{% extends "global/Page.html" %}
{% load otree static %}

{% block title %}
    第 {{ player.round_number }} ラウンド：罰を与えるフェーズ
{% endblock %}

{% block content %}

<div class="card bg-light mb-3">
    <div class="card-body d-flex justify-content-between align-items-center">
        <div>
            <p class="mb-1">このラウンドであなたが使用できる罰のポイントは、合計で <strong><span id="total-deduction-points">{{ session.config.deduction_points }}</span></strong> ポイントです。</p>
            <p class="mb-0">使用した罰ポイントの合計: <strong><span id="used-points">0</span></strong> / {{ session.config.deduction_points }}</p>
        </div>
        {% if history_rounds %}
        <button type="button" class="btn btn-info" data-toggle="modal" data-target="#historyModal">
            <i class="fas fa-history"></i> 全履歴を見る
        </button>
        {% endif %}
    </div>
</div>

<div class="card">
    <div class="card-body">
        <h4>罰の決定</h4>
        <p>あなたが与えたい罰のポイント数を、対応するプレイヤーの欄に入力してください。(0以上の整数)</p>
        <form method="post">
            <table class="table table-bordered">
                <thead class="thead-dark">
                    <tr class="text-center">
                        <th>↓罰を与える人 / 罰を受ける人→</th>
                        {% for p in group.get_players %}
                            <th>プレイヤー {{ p.id_in_group }}<br/>(貢献額: {{ p.contribution }})</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for p_row in group.get_players %}
                    <tr>
                        <td class="text-center">
                            {% if p_row == player %}
                                <strong>あなた (プレイヤー {{ p_row.id_in_group }})</strong>
                            {% else %}
                                プレイヤー {{ p_row.id_in_group }}
                            {% endif %}
                        </td>
                        {% for p_col in group.get_players %}
                            <td class="text-center">
                                {% if p_row == player and p_col != player %}
                                    <input type="number" name="punish_p{{ p_col.id_in_group }}" min="0" value="0" class="form-control punishment-input" style="width: 80px; margin: auto;">
                                {% elif p_row == p_col %}
                                    <div style="width: 80px; margin: auto; background-color: #f0f0f0; padding: 6px 0;">--</div>
                                {% else %}
                                    <div style="width: 80px; margin: auto; padding: 6px 0;">?</div>
                                {% endif %}
                            </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="text-right mt-3">
                {% next_button %}
            </div>
        </form>
    </div>
</div>

{# --- 履歴モーダルをインクルード --- #}
{% if history_rounds %}
    {% include "game/_HistoryModal.html" %}
{% endif %}

{% endblock %}


{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const inputs = document.querySelectorAll('.punishment-input');
        const usedPointsSpan = document.getElementById('used-points');
        const totalDeductionPoints = parseInt(document.getElementById('total-deduction-points').innerText);

        function updateTotal() {
            let totalUsed = 0;
            inputs.forEach(function(input) {
                const value = parseInt(input.value);
                if (!isNaN(value) && value > 0) {
                    totalUsed += value;
                }
            });
            usedPointsSpan.innerText = totalUsed;

            if (totalUsed > totalDeductionPoints) {
                usedPointsSpan.style.color = 'red';
                usedPointsSpan.style.fontWeight = 'bold';
            } else {
                usedPointsSpan.style.color = 'black';
                usedPointsSpan.style.fontWeight = 'normal';
            }
        }

        inputs.forEach(function(input) {
            input.addEventListener('input', updateTotal);
        });

        updateTotal();
    });
</script>
{% endblock %}


{# The custom JS filter is needed for the history modal #}
{% block internal_scripts %}
    <script>
        function sum_list(list) {
            if (!Array.isArray(list)) return 0;
            return list.reduce((a, b) => a + (b || 0), 0);
        }
        if (typeof otree !== 'undefined' && otree.api && typeof otree.api.setTemplateFilters === 'function') {
            otree.api.setTemplateFilters({ sum_list: sum_list });
        }
    </script>
{% endblock %}
