{% extends "global/Page.html" %}
{% load otree %}

{% block title %}
    第{{ round_number }}ラウンド - 懲罰決定
{% endblock %}

{% block content %}
<div class="container">
    <div class="card mb-3">
        <div class="card-header bg-warning">
            <h4 class="mb-0">懲罰決定</h4>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="alert alert-info">
                        <p class="mb-0"><strong>利用可能な懲罰権：</strong>
                            <span class="h4">{{ punishment_endowment|floatformat:1 }}</span>ポイント
                        </p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="alert alert-secondary">
                        <p class="mb-0"><strong>私の貢献：</strong>
                            <span class="h4">{{ my_contribution|floatformat:0 }}</span>
                        </p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="alert alert-secondary">
                        <p class="mb-0"><strong>平均貢献：</strong>
                            <span class="h4">{{ avg_contribution|floatformat:1 }}</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-body">
            <form method="post">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>プレイヤー</th>
                            <th>貢献額</th>
                            <th>平均との差</th>
                            <th>懲罰ポイント</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for other in others_data %}
                        <tr>
                            <td>{{ other.player_code }}</td>
                            <td>{{ other.contribution|floatformat:0 }}</td>
                            <td>
                                {% with diff=other.contribution|add:avg_contribution|floatformat:1 %}
                                {% if other.contribution < avg_contribution %}
                                    <span class="text-danger">-{{ avg_contribution|add:"-"|add:other.contribution|floatformat:1 }}</span>
                                {% else %}
                                    <span class="text-success">+{{ other.contribution|add:"-"|add:avg_contribution|floatformat:1 }}</span>
                                {% endif %}
                                {% endwith %}
                            </td>
                            <td>
                                <input type="number" 
                                       name="punish_p{{ other.id_in_group }}" 
                                       class="form-control punishment-input"
                                       min="0" 
                                       max="{{ punishment_endowment|floatformat:0 }}" 
                                       value="0"
                                       style="width: 100px;">
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr class="table-warning">
                            <td colspan="3" class="text-right"><strong>使用総計：</strong></td>
                            <td><strong id="total-punishment">0</strong> / {{ punishment_endowment|floatformat:1 }}</td>
                        </tr>
                    </tfoot>
                </table>
                
                <div class="alert alert-danger" id="error-message" style="display: none;">
                    懲罰総量が利用可能な懲罰権を超えています！
                </div>
                
                <div class="mt-3">
                    <button type="button" class="btn btn-info" data-toggle="modal" data-target="#historyModal">
                        履歴を見る
                    </button>
                    <button type="submit" class="btn btn-primary" id="submit-btn">懲罰決定を確定</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 履歴モーダル -->
<div class="modal fade" id="historyModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">履歴</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                {% if history %}
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>ラウンド</th>
                            <th>貢献</th>
                            <th>貢献利得</th>
                            <th>与えた懲罰</th>
                            <th>受けた懲罰</th>
                            <th>ラウンド利得</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for h in history %}
                        <tr>
                            <td>{{ h.round }}</td>
                            <td>{{ h.contribution|floatformat:0 }}</td>
                            <td>{{ h.payoff_from_contribution|floatformat:1 }}</td>
                            <td>{{ h.punishment_sent|floatformat:0 }}</td>
                            <td>{{ h.punishment_received|floatformat:0 }}</td>
                            <td>{{ h.round_payoff|floatformat:1 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p>履歴データがありません。</p>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">閉じる</button>
            </div>
        </div>
    </div>
</div>

<!-- 存储配置数据 -->
<div id="punishment-config" style="display:none;"
     data-max-punishment="{{ punishment_endowment|floatformat:1 }}">
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 获取配置
    var config = document.getElementById('punishment-config');
    var maxPunishment = parseFloat(config.getAttribute('data-max-punishment'));
    
    // DOM元素
    var inputs = document.querySelectorAll('.punishment-input');
    var totalSpan = document.getElementById('total-punishment');
    var errorMsg = document.getElementById('error-message');
    var submitBtn = document.getElementById('submit-btn');
    
    function updateTotal() {
        var total = 0;
        inputs.forEach(function(input) {
            total += parseInt(input.value) || 0;
        });
        
        totalSpan.textContent = total;
        
        if (total > maxPunishment) {
            totalSpan.classList.add('text-danger');
            errorMsg.style.display = 'block';
            submitBtn.disabled = true;
        } else {
            totalSpan.classList.remove('text-danger');
            errorMsg.style.display = 'none';
            submitBtn.disabled = false;
        }
    }
    
    // 添加事件监听
    inputs.forEach(function(input) {
        input.addEventListener('input', updateTotal);
        input.addEventListener('change', updateTotal);
    });
    
    // 初始更新
    updateTotal();
});
</script>
{% endblock %}