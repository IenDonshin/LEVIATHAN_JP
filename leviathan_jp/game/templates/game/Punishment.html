{% extends "global/Page.html" %}
{% load otree static %}

{% block title %}
    第 {{ player.round_number }} ラウンド：罰を与えるフェーズ
{% endblock %}

{% block content %}

<div class="card bg-light mb-3">
    <div class="card-body d-flex justify-content-between align-items-center">
        <div>
            <p class="mb-1">このラウンドであなたが使用できる罰ポイントは、 <strong><span id="total-deduction-points">{{ session.config.deduction_points }}</span></strong> ポイントです。</p>
            <p class="mb-0">使用済みの罰ポイント: <strong><span id="used-points">0</span></strong> / {{ session.config.deduction_points }}</p>
            <p class="mb-0">残りのMUs: <strong>{{ remaining_mu }}</strong></p>
        </div>
        {% if history_rounds %}
        <button type="button" class="btn btn-info" data-toggle="modal" data-bs-toggle="modal"
                data-target="#historyModal" data-bs-target="#historyModal" data-history-modal="true">
            <i class="fas fa-history"></i> 全履歴をチェック
        </button>
        {% endif %}
    </div>
</div>

<div class="card">
    <div class="card-body">
        <h4>罰の決定</h4>
        <p>あなたが与えたい罰ポイント数を、対応するプレイヤーの欄に入力してください。(0以上の整数)</p>
        <form method="post">
            <table class="table table-bordered">
                <thead class="thead-dark">
                    <tr class="text-center align-middle">
                        <th rowspan="2" class="punishment-header-arrow">↓罰を与える人 / 罰を受ける人→</th>
                        {% for p in group.get_players %}
                            <th>プレイヤー {{ p.id_in_group }}</th>
                        {% endfor %}
                    </tr>
                    <tr class="text-center small">
                        {% for p in group.get_players %}
                            <th>(貢献額: {{ p.contribution }})</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="text-center"><strong>あなた (プレイヤー {{ player.id_in_group }})</strong></td>
                        {% for p_col in group.get_players %}
                            <td class="text-center">
                                {% if p_col == player %}
                                    <div style="width: 80px; margin: auto; background-color: #f0f0f0; padding: 6px 0;">--</div>
                                {% elif p_col.can_receive_punishment %}
                                    <input type="number" name="punish_p{{ p_col.id_in_group }}" min="0" value="0" class="form-control punishment-input" style="width: 80px; margin: auto;">
                                {% else %}
                                    <div style="width: 80px; margin: auto; background-color: #f8d7da; color: #721c24; padding: 6px 0;">免罰</div>
                                {% endif %}
                            </td>
                        {% endfor %}
                    </tr>
                </tbody>
            </table>
            <div class="text-right mt-3">
                {% next_button %}
            </div>
        </form>
    </div>
</div>

{# --- 履歴モーダルをインクルード --- #}
{% if history_rounds %}
    {% include "game/_HistoryModal.html" %}
{% endif %}

{% endblock %}


{% block scripts %}
<script>
    function enhanceNumericInput(input, options) {
        if (!input || input.dataset.numericStepper === 'true') {
            return;
        }
        const step = options.step || 1;
        const min = typeof options.min === 'number' ? options.min : 0;
        const max = typeof options.max === 'number' ? options.max : Infinity;
        const decimals = options.decimals != null ? options.decimals : (Number.isInteger(step) ? 0 : (step.toString().split('.')[1] || '').length);

        const wrapper = document.createElement('div');
        wrapper.className = 'numeric-step-wrapper';
        if (options.width) {
            wrapper.style.width = options.width;
        }

        const parent = input.parentNode;
        parent.insertBefore(wrapper, input);
        wrapper.appendChild(input);

        input.classList.add('numeric-step-input');
        input.dataset.numericStepper = 'true';

        const buttons = document.createElement('div');
        buttons.className = 'numeric-step-buttons';

        const upBtn = document.createElement('button');
        upBtn.type = 'button';
        upBtn.textContent = '▲';
        buttons.appendChild(upBtn);

        const downBtn = document.createElement('button');
        downBtn.type = 'button';
        downBtn.textContent = '▼';
        buttons.appendChild(downBtn);

        wrapper.appendChild(buttons);

        function formatValue(value) {
            return value.toFixed(decimals);
        }

        function adjust(direction) {
            let current = parseFloat(input.value);
            if (Number.isNaN(current)) {
                current = 0;
            }
            let next = current + direction * step;
            if (next < min) {
                next = min;
            }
            if (Number.isFinite(max)) {
                next = Math.min(next, max);
            }
            next = Math.round(next / step) * step;
            input.value = formatValue(next);
            input.dispatchEvent(new Event('input', { bubbles: true }));
            input.dispatchEvent(new Event('change', { bubbles: true }));
        }

        upBtn.addEventListener('click', function (event) {
            event.preventDefault();
            adjust(1);
        });

        downBtn.addEventListener('click', function (event) {
            event.preventDefault();
            adjust(-1);
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        const inputs = document.querySelectorAll('.punishment-input');
        const usedPointsSpan = document.getElementById('used-points');
        const totalDeductionPoints = parseInt(document.getElementById('total-deduction-points').innerText);
        const maxPerTarget = Number.isNaN(totalDeductionPoints) ? Infinity : totalDeductionPoints;

        function updateTotal() {
            let totalUsed = 0;
            inputs.forEach(function(input) {
                const value = parseInt(input.value);
                if (!isNaN(value) && value > 0) {
                    totalUsed += value;
                }
            });
            usedPointsSpan.innerText = totalUsed;

            if (totalUsed > totalDeductionPoints) {
                usedPointsSpan.style.color = 'red';
                usedPointsSpan.style.fontWeight = 'bold';
            } else {
                usedPointsSpan.style.color = 'black';
                usedPointsSpan.style.fontWeight = 'normal';
            }
        }

        inputs.forEach(function(input) {
            input.setAttribute('step', '1');
            input.setAttribute('min', '0');
            if (Number.isFinite(maxPerTarget)) {
                input.setAttribute('max', maxPerTarget.toString());
            }
            enhanceNumericInput(input, {
                step: 1,
                min: 0,
                max: maxPerTarget,
                decimals: 0,
                width: '6.5rem'
            });
            input.addEventListener('input', updateTotal);
        });

        updateTotal();
    });
</script>
{% endblock %}


{# 履歴モーダルで使用するカスタム JS フィルター #}
{% block internal_scripts %}
    <style>
        .punishment-header-arrow {
            white-space: nowrap;
        }

        .numeric-step-wrapper {
            position: relative;
            display: inline-block;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            overflow: hidden;
            background: #fff;
        }

        .numeric-step-wrapper .numeric-step-input {
            width: 100%;
            text-align: center;
            padding-right: 1.75rem;
            margin: 0;
            border: none;
            height: 100%;
        }

        .numeric-step-wrapper .numeric-step-buttons {
            position: absolute;
            top: 1px;
            bottom: 1px;
            right: 1px;
            width: 1.6rem;
            display: flex;
            flex-direction: column;
        }

        .numeric-step-wrapper .numeric-step-buttons button {
            flex: 1;
            border: 0;
            border-left: 1px solid #ced4da;
            background: #f8f9fa;
            font-size: 0.7rem;
            line-height: 1;
            padding: 0;
            cursor: pointer;
        }

        .numeric-step-wrapper .numeric-step-buttons button:first-child {
            border-top-right-radius: 0.25rem;
            border-bottom: 1px solid #ced4da;
        }

        .numeric-step-wrapper .numeric-step-buttons button:last-child {
            border-bottom-right-radius: 0.25rem;
        }

        .numeric-step-wrapper input[type=number]::-webkit-inner-spin-button,
        .numeric-step-wrapper input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .numeric-step-wrapper input[type=number] {
            appearance: none;
            -moz-appearance: textfield;
        }
    </style>
    <script>
        function sum_list(list) {
            if (!Array.isArray(list)) return 0;
            return list.reduce((a, b) => a + (b || 0), 0);
        }
        if (typeof otree !== 'undefined' && otree.api && typeof otree.api.setTemplateFilters === 'function') {
            otree.api.setTemplateFilters({ sum_list: sum_list });
        }
    </script>
{% endblock %}
