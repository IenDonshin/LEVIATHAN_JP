{% extends "global/Page.html" %}
{% load otree static %}

{% block title %}
    罰ステージ
{% endblock %}

{% block content %}

<div class="stage-layout">
    <div class="stage-header">
        <div>
            <div class="stage-title">罰ステージ</div>
            <div class="stage-subtitle">第 {{ player.round_number }} ラウンド</div>
        </div>
        <div class="stage-desc">
            罰ポイント（DP）を他の参加者に割り当てます。<br>
            各プレイヤーへの配分は 0 から {{ deduction_points }} の範囲です。
        </div>
    </div>

    <div class="stage-center">
        <div class="stage-stack" style="width: 100%;">
            <div class="action-row">
                <div class="summary-chip">使用可能DP: <span id="total-deduction-points">{{ deduction_points }}</span></div>
                <div class="summary-chip">使用済みDP: <span id="used-points">0</span></div>
                <div class="summary-chip">残りMUs: {{ remaining_mu }}</div>
                {% if history_rounds %}
                <button type="button" class="btn ui-button-ghost" data-toggle="modal" data-bs-toggle="modal"
                        data-target="#historyModal" data-bs-target="#historyModal" data-history-modal="true">
                    全履歴をチェック
                </button>
                {% endif %}
            </div>

            <div style="width: 100%;">
                <table class="matrix-table matrix-table--inputs punishment-table">
                    <thead>
                        <tr>
                            <th></th>
                            {% for col in players_data %}
                                <th>
                                    {% if col.is_self %}
                                        あなた
                                    {% else %}
                                        プレイヤー {{ col.id_in_group }}
                                    {% endif %}
                                </th>
                            {% endfor %}
                        </tr>
                        <tr>
                            <th class="matrix-note">拠出額</th>
                            {% for col in players_data %}
                                <th>
                                    <div class="bar-track bar-track--compact"
                                         data-value="{{ col.contribution }}"
                                         data-max="{{ endowment }}">
                                        <div class="bar-fill"></div>
                                        <span class="bar-text">{{ col.contribution }} / {{ endowment }}</span>
                                    </div>
                                </th>
                            {% endfor %}
                        </tr>
                        <tr>
                            <th class="matrix-note">DPコスト</th>
                            {% for col in players_data %}
                                <th>
                                    {% if col.is_self %}
                                        <div class="dp-cost-box">
                                            <span id="dp-cost-self">0</span> / {{ max_punishment_cost_display }}
                                        </div>
                                    {% else %}
                                        <div class="dp-cost-box dp-cost-box--empty">?</div>
                                    {% endif %}
                                </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in players_data %}
                        <tr>
                            <td class="matrix-note">
                                <div class="player-row-label">
                                    <span class="player-name">
                                        {% if row.is_self %}
                                            あなた
                                        {% else %}
                                            プレイヤー {{ row.id_in_group }}
                                        {% endif %}
                                    </span>
                                    <span class="power-tag">({{ row.power_display }})</span>
                                    <span class="cost-tag">
                                        {% if row.is_self %}
                                            (<span id="dp-cost-inline">0</span>)
                                        {% else %}
                                            (?)
                                        {% endif %}
                                    </span>
                                </div>
                            </td>
                            {% for col in players_data %}
                                {% if row.id_in_group == col.id_in_group %}
                                    <td class="is-self">--</td>
                                {% elif row.is_self %}
                                    <td>
                                        <div class="input-with-slider input-with-slider--compact matrix-input-row">
                                            <input type="number"
                                                   name="punish_p{{ col.id_in_group }}"
                                                   min="0"
                                                   value="0"
                                                   class="punishment-input decision-number"
                                                   data-target="{{ col.id_in_group }}">
                                            <input type="range"
                                                   class="ui-slider ui-slider--compact"
                                                   min="0"
                                                   max="{{ deduction_points }}"
                                                   step="1"
                                                   value="0">
                                            <span class="cell-effect" data-effect-for="{{ col.id_in_group }}">(0)</span>
                                        </div>
                                    </td>
                                {% else %}
                                    <td class="matrix-placeholder">?</td>
                                {% endif %}
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="action-row">
                {% next_button %}
            </div>
        </div>
    </div>
</div>

{% if history_rounds %}
    {% include "game/_HistoryModal.html" %}
{% endif %}

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const inputs = document.querySelectorAll('.punishment-input');
        const usedPointsSpan = document.getElementById('used-points');
        const totalDeductionPoints = parseInt(document.getElementById('total-deduction-points').innerText);
        const maxPerTarget = Number.isNaN(totalDeductionPoints) ? Infinity : totalDeductionPoints;
        const costPerPoint = parseFloat('{{ punishment_cost }}');
        const maxCost = parseFloat('{{ max_punishment_cost }}');
        const dpCostSelf = document.getElementById('dp-cost-self');
        const dpCostInline = document.getElementById('dp-cost-inline');
        const powerValue = parseFloat('{{ self_power_value }}');
        const powerText = Number.isFinite(powerValue) ? powerValue : 1.0;
        const effectBase = parseFloat('{{ power_effectiveness }}') || 1.0;

        function updateTotal() {
            let totalUsed = 0;
            inputs.forEach(function(input) {
                const value = parseInt(input.value);
                if (!isNaN(value) && value > 0) {
                    totalUsed += value;
                }
            });
            usedPointsSpan.innerText = totalUsed;

            const totalCost = Number.isFinite(costPerPoint) ? totalUsed * costPerPoint : totalUsed;
            if (dpCostSelf) {
                dpCostSelf.innerText = totalCost.toFixed(1);
            }
            if (dpCostInline) {
                dpCostInline.innerText = totalCost.toFixed(1);
            }

            document.querySelectorAll('.cell-effect').forEach(function(effectEl) {
                const targetId = effectEl.dataset.effectFor;
                const inputEl = document.querySelector('.punishment-input[data-target="' + targetId + '"]');
                if (!inputEl) {
                    return;
                }
                const value = parseFloat(inputEl.value);
                if (!Number.isFinite(value) || value <= 0) {
                    effectEl.textContent = '(0)';
                    return;
                }
                const loss = value * effectBase * powerText;
                effectEl.textContent = '(-' + loss.toFixed(1) + ')';
            });

            if (totalUsed > totalDeductionPoints) {
                usedPointsSpan.style.color = 'var(--ui-danger)';
                usedPointsSpan.style.fontWeight = 'bold';
            } else {
                usedPointsSpan.style.color = 'var(--ui-text)';
                usedPointsSpan.style.fontWeight = 'normal';
            }
        }

        inputs.forEach(function(input) {
            input.setAttribute('step', '1');
            input.setAttribute('min', '0');
            if (Number.isFinite(maxPerTarget)) {
                input.setAttribute('max', maxPerTarget.toString());
            }
            input.addEventListener('input', updateTotal);
        });

        updateTotal();
        if (window.initInputSliders) {
            window.initInputSliders();
        }
    });
</script>
{% endblock %}

{% block internal_scripts %}
    {{ super() }}
    <style>
        .punishment-table th {
            vertical-align: bottom;
        }

        .punishment-table .bar-track--compact {
            width: 120px;
        }

        .punishment-table .bar-track--compact .bar-text {
            font-size: 0.7rem;
        }

        .dp-cost-box {
            border: 1px solid var(--ui-warn-strong);
            color: var(--ui-warn-strong);
            font-size: 0.72rem;
            padding: 0.3rem 0.35rem;
            border-radius: 2px;
            text-align: center;
        }

        .dp-cost-box--empty {
            color: rgba(226, 182, 69, 0.5);
        }

        .player-row-label {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.78rem;
        }

        .player-name {
            min-width: 76px;
            display: inline-block;
        }

        .power-tag {
            color: var(--ui-accent);
        }

        .cost-tag {
            color: var(--ui-warn-strong);
        }

        .matrix-placeholder {
            border: 1px solid var(--ui-warn-strong);
            color: rgba(226, 182, 69, 0.45);
            padding: 0.5rem 0;
        }

        .cell-effect {
            color: var(--ui-warn-strong);
            font-size: 0.7rem;
            min-width: 36px;
            text-align: left;
        }
    </style>
{% endblock %}
