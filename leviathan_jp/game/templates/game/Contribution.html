{% extends "global/Page.html" %}
{% load otree static %}

{% block title %}
    第 {{ player.round_number }} ラウンド：貢献
{% endblock %}

{% block content %}

<div class="card bg-light mb-3">
    <div class="card-body">
        <p>
            现在是第 {{ player.round_number }} / {{ C.num_rounds }} ラウンドです。
        </p>
        <p>
            あなたの初期保有額は <strong>{{ session.config.endowment }}</strong> MU (Monetary Units) です。
        </p>
        <p>
            このラウンドで、公共プロジェクトに貢献したい金額を入力してください。(0 から {{ session.config.endowment }} の間の整数)
        </p>
        
        {% formfields %}
        
        <div class="d-flex justify-content-between align-items-center mt-3">
            {% if history_rounds %}
            <button type="button" class="btn btn-info" data-toggle="modal" data-bs-toggle="modal"
                    data-target="#historyModal" data-bs-target="#historyModal" data-history-modal="true">
                <i class="fas fa-history"></i> 全履歴を見る
            </button>
            {% else %}
            <span></span> {# Keeps the next button to the right #}
            {% endif %}
            
            {% next_button %}
        </div>
    </div>
</div>

{# --- 履歴モーダルをインクルード --- #}
{% if player.round_number > 1 and history_rounds %}
    {% include "game/_HistoryModal.html" %}
{% endif %}

{% endblock %}


{# The custom JS helper is needed for the history modal #}
{% block internal_scripts %}
    <script>
        function sum_list(list) {
            if (!Array.isArray(list)) return 0;
            return list.reduce((a, b) => a + (b || 0), 0);
        }
        if (typeof otree !== 'undefined' && otree.api && typeof otree.api.setTemplateFilters === 'function') {
            otree.api.setTemplateFilters({ sum_list: sum_list });
        }
    </script>
{% endblock %}
