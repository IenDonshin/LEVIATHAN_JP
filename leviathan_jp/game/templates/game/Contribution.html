{% extends "global/Page.html" %}
{% load otree static %}

{% block title %}
    貢献ステージ
{% endblock %}

{% block content %}

<div class="stage-layout contribution-layout">
    <div class="stage-header">
        <div>
            <div class="stage-title">貢献ステージ</div>
            <div class="stage-subtitle">第 {{ player.round_number }} / {{ C.num_rounds }} ラウンド</div>
        </div>
        <div class="stage-desc contribution-desc">
            <span class="desc-line">あなたの保有額は {{ available_endowment_display }} MUs です。</span>
            <span class="desc-line">0 から {{ contribution_limit_display }} の範囲でグループプロジェクトへの貢献MUsを入力してください。</span>
        </div>
    </div>

    <div class="stage-center contribution-center">
        <div class="contribution-upper">
            {% if history_rounds %}
            <button type="button" class="btn ui-button-ghost" data-toggle="modal" data-bs-toggle="modal"
                    data-target="#historyModal" data-bs-target="#historyModal" data-history-modal="true">
                全履歴をチェック
            </button>
            {% endif %}
        </div>

        <div class="contribution-middle">
            <div class="contribution-input">
                <label class="ui-label">貢献MUs</label>
                <div class="input-with-slider input-with-slider--stacked contribution-control">
                    <div class="slider-shell">
                        <input type="range"
                               id="contribution-range"
                               class="ui-slider ui-slider--bar ui-slider--blue"
                               min="0"
                               max="{{ available_endowment }}"
                               step="1"
                               value="{{ initial_contribution }}">
                        <span class="contribution-thumb" id="contribution-thumb" aria-hidden="true"></span>
                        <span class="slider-value" id="contribution-range-value">{{ initial_contribution }}</span>
                    </div>
                    <div class="input-compact">
                        {{ form.contribution }}
                    </div>
                </div>
            </div>
        </div>

        <div class="contribution-lower contribution-footer">
            {% next_button %}
        </div>
    </div>
</div>

{% if player.round_number > 1 and history_rounds %}
    {% include "game/_HistoryModal.html" %}
{% endif %}

{% endblock %}

{% block internal_scripts %}
    {{ super() }}
    <style>
        .contribution-input {
            --contrib-bar-height: var(--ui-common-bar-height);
            --contrib-bar-width: calc(var(--ui-common-bar-width) * 2);
            --contrib-frame: 1px;
        }

        .contribution-desc {
            max-width: none;
            width: auto;
            text-align: right;
        }

        .contribution-desc .desc-line {
            display: block;
            white-space: nowrap;
            line-height: 1.45;
        }

        @media (max-width: 980px) {
            .contribution-desc .desc-line {
                white-space: normal;
            }
        }

        .contribution-input {
            width: var(--contrib-bar-width);
        }

        .contribution-input .input-compact {
            width: 72px;
        }

        .contribution-layout {
            gap: 1.2rem;
        }

        .contribution-center {
            display: grid;
            grid-template-rows: 1fr auto 1fr;
            align-items: stretch;
            min-height: min(60vh, 520px);
        }

        .contribution-upper {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding-bottom: 72px;
        }

        .contribution-middle {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .contribution-upper .ui-button-ghost {
            width: 152px;
        }

        .contribution-control {
            align-items: center;
        }

        .contribution-control .input-group {
            width: 100%;
        }

        .contribution-control .input-group-text {
            display: none;
        }

        .contribution-control .form-control {
            font-size: 0.85rem;
            padding: 0.2rem 0.35rem;
        }

        .input-with-slider--stacked {
            flex-direction: column;
            gap: 0.6rem;
        }

        .slider-shell {
            position: relative;
            width: var(--contrib-bar-width);
            height: var(--contrib-bar-height);
            border: var(--contrib-frame) solid var(--ui-border);
            background: #2a2a2a;
            overflow: hidden;
        }

        #contribution-range.ui-slider.ui-slider--bar {
            width: 100%;
            height: 100%;
            margin: 0;
            border: none;
            border-radius: 0;
            display: block;
            background: transparent;
            padding: 0;
        }

        #contribution-range.ui-slider::-webkit-slider-runnable-track {
            height: 100%;
            background: transparent;
            border: none;
        }

        #contribution-range.ui-slider::-moz-range-track {
            height: 100%;
            background: transparent;
            border: none;
        }

        #contribution-range.ui-slider::-webkit-slider-thumb {
            appearance: none;
            width: 1px;
            height: 1px;
            border: none;
            background: transparent;
            opacity: 0;
        }

        #contribution-range.ui-slider::-moz-range-thumb {
            width: 1px;
            height: 1px;
            border: none;
            background: transparent;
            opacity: 0;
        }

        .contribution-thumb {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            width: calc(var(--contrib-bar-height) * 0.42);
            border: var(--contrib-frame) solid #f2f2f2;
            box-sizing: border-box;
            background: rgba(47, 95, 167, 0.72);
            pointer-events: none;
            z-index: 3;
        }

        .slider-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.85rem;
            color: #ffffff;
            font-weight: 600;
            pointer-events: none;
        }

        .contribution-lower {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 72px;
        }

        .contribution-lower .otree-btn-next,
        .contribution-lower .otree-next-button,
        .contribution-lower button[type="submit"],
        .contribution-lower .btn-primary {
            flex: 0 0 auto;
            width: fit-content !important;
            min-width: 0 !important;
            padding-left: 1.35rem;
            padding-right: 1.35rem;
            margin-left: auto;
            margin-right: auto;
            margin-bottom: 0;
        }
    </style>
    <script>
        function setDecisionSubmitLabel() {
            var submitButton = document.querySelector('button.otree-next-button, button.otree-btn-next');
            if (submitButton) {
                submitButton.textContent = '決定';
            }
        }

        function sum_list(list) {
            if (!Array.isArray(list)) return 0;
            return list.reduce((a, b) => a + (b || 0), 0);
        }
        if (typeof otree !== 'undefined' && otree.api && typeof otree.api.setTemplateFilters === 'function') {
            otree.api.setTemplateFilters({ sum_list: sum_list });
        }

        document.addEventListener('DOMContentLoaded', function () {
            setDecisionSubmitLabel();

            var contributionInput = document.querySelector('input[name="contribution"]');
            if (!contributionInput) {
                return;
            }

            contributionInput.classList.add('ui-input');
            contributionInput.classList.add('js-slider-input');

            var maxVal = parseFloat('{{ available_endowment }}');
            if (!Number.isFinite(maxVal)) {
                maxVal = 0;
            }
            var initialVal = parseFloat('{{ initial_contribution }}');
            if (!Number.isFinite(initialVal) || initialVal < 0) {
                initialVal = 0;
            }
            initialVal = Math.min(maxVal, Math.round(initialVal));

            var current = parseFloat(contributionInput.value);
            if (Number.isNaN(current) || current < 0) {
                contributionInput.value = initialVal.toString();
            } else {
                current = Math.round(current);
                if (current === 0 && initialVal > 0) {
                    current = initialVal;
                }
                contributionInput.value = current.toString();
            }

            contributionInput.setAttribute('step', '1');
            contributionInput.setAttribute('min', '0');
            contributionInput.setAttribute('max', maxVal.toString());

            var rangeInput = document.getElementById('contribution-range');
            var valueEl = document.getElementById('contribution-range-value');
            var thumbEl = document.getElementById('contribution-thumb');
            var originalUpdateSliderFill = window.updateSliderFill;

            function updateContributionThumb() {
                if (!rangeInput || !thumbEl) {
                    return;
                }
                var min = parseFloat(rangeInput.min || '0');
                var max = parseFloat(rangeInput.max || '0');
                var value = parseFloat(rangeInput.value || '0');
                if (!Number.isFinite(min)) {
                    min = 0;
                }
                if (!Number.isFinite(max) || max <= min) {
                    max = min + 1;
                }
                if (!Number.isFinite(value)) {
                    value = min;
                }
                var pct = (value - min) / (max - min);
                pct = Math.max(0, Math.min(1, pct));

                var trackWidth = rangeInput.getBoundingClientRect().width || 0;
                var thumbWidth = thumbEl.getBoundingClientRect().width || 0;
                var left = pct * Math.max(0, trackWidth - thumbWidth);
                thumbEl.style.left = left.toFixed(2) + 'px';
            }

            if (typeof originalUpdateSliderFill === 'function') {
                window.updateSliderFill = function (targetRangeInput) {
                    originalUpdateSliderFill(targetRangeInput);
                    if (targetRangeInput === rangeInput) {
                        updateContributionThumb();
                    }
                };
            }

            function updateBar() {
                var value = parseFloat(contributionInput.value);
                if (!Number.isFinite(value)) {
                    value = 0;
                }
                value = Math.round(value);
                contributionInput.value = value.toString();
                if (rangeInput) {
                    rangeInput.value = value.toString();
                }
                if (valueEl) {
                    valueEl.textContent = value.toString();
                }
                if (window.updateSliderFill) {
                    window.updateSliderFill(rangeInput);
                }
            }

            contributionInput.addEventListener('input', updateBar);
            if (rangeInput) {
                rangeInput.addEventListener('input', updateContributionThumb);
                rangeInput.addEventListener('change', updateContributionThumb);
            }
            window.addEventListener('resize', updateContributionThumb);
            updateBar();
            if (window.initInputSliders) {
                window.initInputSliders();
            }
            updateContributionThumb();
        });
    </script>
{% endblock %}
