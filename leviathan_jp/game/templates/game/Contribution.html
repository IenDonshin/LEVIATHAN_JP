{% extends "global/Page.html" %}
{% load otree static %}

{% block title %}
    第 {{ player.round_number }} ラウンド：貢献
{% endblock %}

{% block content %}

<div class="card bg-light mb-3">
    <div class="card-body">
        <p>
            今は第 {{ player.round_number }} / {{ C.num_rounds }} ラウンドです。
        </p>
        <p>
            あなたの初期保有額は <strong>{{ session.config.endowment }}</strong> MUs (Monetary Units) です。
        </p>
        <p>
            今ラウンドで移転コストなどを差し引いた後に使える残額は <strong>{{ available_endowment }}</strong> です。
            このラウンドで公共プールにいくら拠出しますか？ (0 から {{ available_endowment }} の範囲で整数)
        </p>
        
        {% formfields %}
        
        <div class="d-flex justify-content-between align-items-center mt-3">
            {% if history_rounds %}
            <button type="button" class="btn btn-info" data-toggle="modal" data-bs-toggle="modal"
                    data-target="#historyModal" data-bs-target="#historyModal" data-history-modal="true">
                <i class="fas fa-history"></i> 全履歴を見る
            </button>
            {% else %}
            <span></span> {# 次へボタンを右側に維持するためのスペース #}
            {% endif %}
            
            {% next_button %}
        </div>
    </div>
</div>

{# --- 履歴モーダルを読み込む --- #}
{% if player.round_number > 1 and history_rounds %}
    {% include "game/_HistoryModal.html" %}
{% endif %}

{% endblock %}


{# 履歴モーダルで使用するカスタム JS ヘルパー #}
{% block internal_scripts %}
    <script>
        function sum_list(list) {
            if (!Array.isArray(list)) return 0;
            return list.reduce((a, b) => a + (b || 0), 0);
        }
        if (typeof otree !== 'undefined' && otree.api && typeof otree.api.setTemplateFilters === 'function') {
            otree.api.setTemplateFilters({ sum_list: sum_list });
        }

        document.addEventListener('DOMContentLoaded', function () {
            var contributionInput = document.querySelector('input[name="contribution"]');
            if (!contributionInput) {
                return;
            }

            var current = contributionInput.value;
            if (current === '' || current === null) {
                contributionInput.value = '0';
            } else {
                var parsed = parseInt(current, 10);
                if (Number.isNaN(parsed)) {
                    contributionInput.value = '0';
                } else {
                    contributionInput.value = parsed.toString();
                }
            }
            contributionInput.setAttribute('step', '1');
            contributionInput.setAttribute('min', '0');
            contributionInput.setAttribute('max', '{{ available_endowment }}');
        });
    </script>
{% endblock %}
