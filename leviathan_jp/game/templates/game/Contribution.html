{% extends "global/Page.html" %}
{% load otree static %}

{% block title %}
    貢献ステージ
{% endblock %}

{% block content %}

<div class="stage-layout">
    <div class="stage-header">
        <div>
            <div class="stage-title">貢献ステージ</div>
            <div class="stage-subtitle">第 {{ player.round_number }} / {{ C.num_rounds }} ラウンド</div>
        </div>
        <div class="stage-desc">
            あなたの保有額は {{ available_endowment }} MUs です。<br>
            0 から {{ available_endowment }} の範囲で公共プロジェクトへの拠出額を入力してください。
        </div>
    </div>

        <div class="stage-center">
        <div class="stage-stack">
            <div class="contribution-input">
                <label class="ui-label">拠出額 (MUs)</label>
                <div class="input-with-slider input-with-slider--stacked contribution-control">
                    <div class="slider-shell">
                        <input type="range"
                               id="contribution-range"
                               class="ui-slider ui-slider--bar"
                               min="0"
                               max="{{ available_endowment }}"
                               step="1"
                               value="0">
                        <span class="slider-value" id="contribution-range-value">0</span>
                    </div>
                    <div class="input-compact">
                        {{ form.contribution }}
                    </div>
                </div>
            </div>

            <div class="action-row action-row-compact">
                {% if history_rounds %}
                <button type="button" class="btn ui-button-ghost" data-toggle="modal" data-bs-toggle="modal"
                        data-target="#historyModal" data-bs-target="#historyModal" data-history-modal="true">
                    全履歴をチェック
                </button>
                {% endif %}
                {% next_button %}
            </div>
        </div>
    </div>
</div>

{% if player.round_number > 1 and history_rounds %}
    {% include "game/_HistoryModal.html" %}
{% endif %}

{% endblock %}

{% block internal_scripts %}
    {{ super() }}
    <style>
        .contribution-input {
            width: 280px;
        }

        .contribution-input .input-compact {
            width: 72px;
        }

        .contribution-control {
            align-items: center;
        }

        .contribution-control .input-group {
            width: 100%;
        }

        .contribution-control .input-group-text {
            display: none;
        }

        .contribution-control .form-control {
            font-size: 0.85rem;
            padding: 0.2rem 0.35rem;
        }

        .input-with-slider--stacked {
            flex-direction: column;
            gap: 0.6rem;
        }

        .slider-shell {
            position: relative;
            width: 220px;
        }

        .ui-slider.ui-slider--bar {
            width: 100%;
            height: 26px;
            border-radius: 3px;
        }

        .slider-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.85rem;
            color: #ffffff;
            font-weight: 600;
            pointer-events: none;
        }

        .action-row.action-row-compact {
            width: 260px;
        }

        .action-row.action-row-compact .btn,
        .action-row.action-row-compact .otree-next-button {
            flex: 1 1 0;
            width: 100%;
        }
    </style>
    <script>
        function sum_list(list) {
            if (!Array.isArray(list)) return 0;
            return list.reduce((a, b) => a + (b || 0), 0);
        }
        if (typeof otree !== 'undefined' && otree.api && typeof otree.api.setTemplateFilters === 'function') {
            otree.api.setTemplateFilters({ sum_list: sum_list });
        }

        document.addEventListener('DOMContentLoaded', function () {
            var contributionInput = document.querySelector('input[name="contribution"]');
            if (!contributionInput) {
                return;
            }

            contributionInput.classList.add('ui-input');
            contributionInput.classList.add('js-slider-input');

            var maxVal = parseFloat('{{ available_endowment }}');
            if (!Number.isFinite(maxVal)) {
                maxVal = 0;
            }

            var current = parseFloat(contributionInput.value);
            if (Number.isNaN(current) || current < 0) {
                contributionInput.value = '0';
            } else {
                contributionInput.value = Math.round(current).toString();
            }

            contributionInput.setAttribute('step', '1');
            contributionInput.setAttribute('min', '0');
            contributionInput.setAttribute('max', maxVal.toString());

            var rangeInput = document.getElementById('contribution-range');
            var valueEl = document.getElementById('contribution-range-value');

            function updateRangeFill(value) {
                if (!rangeInput) {
                    return;
                }
                var min = parseFloat(rangeInput.min || '0');
                var max = parseFloat(rangeInput.max || '0');
                if (!Number.isFinite(min)) {
                    min = 0;
                }
                if (!Number.isFinite(max) || max <= min) {
                    max = min + 1;
                }
                var pct = ((value - min) / (max - min)) * 100;
                pct = Math.max(0, Math.min(100, pct));
                rangeInput.style.background = 'linear-gradient(to right, #3b74c6 0%, #3b74c6 ' + pct.toFixed(2) + '%, #2a2a2a ' + pct.toFixed(2) + '%, #2a2a2a 100%)';
            }

            function updateBar() {
                var value = parseFloat(contributionInput.value);
                if (!Number.isFinite(value)) {
                    value = 0;
                }
                if (valueEl) {
                    valueEl.textContent = Math.round(value).toString();
                }
                updateRangeFill(value);
            }

            contributionInput.addEventListener('input', updateBar);
            updateBar();
            if (window.initInputSliders) {
                window.initInputSliders();
            }
        });
    </script>
{% endblock %}
