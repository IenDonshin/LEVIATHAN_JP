{% extends "global/Page.html" %}
{% load otree static %}

{% block title %}
    第 {{ player.round_number }} ラウンド：最終結果
{% endblock %}

{% block content %}

{# ================================================================= #}
{# 1. このプレイヤーの個人収益サマリー                              #}
{# ================================================================= #}
<div class="card bg-light mb-3">
    <div class="card-body">
        <h4 class="card-title">あなたの利得サマリー</h4>
        <table class="table table-borderless" style="font-size: 1.1em;">
            <tr>
                <td>貢献フェーズでの利得</td>
                <td class="text-right">{{ payoff_from_contribution }} </td>
                <td>(初期保有額 - あなたの貢献 + 公共プールからの取り分)</td>
            </tr>
            <tr>
                <td>罰を与えたコスト</td>
                <td class="text-right text-danger">- {{ player.punishment_given }} </td>
                <td></td>
            </tr>
            <tr>
                <td>受けた罰による損失</td>
                <td class="text-right text-danger">- {{ player.punishment_received }} </td>
                <td></td>
            </tr>
            {% if show_power_transfer and player.session.config.costly_punishment_transfer %}
            <tr>
                <td>罰威力移転によるコスト</td>
                <td class="text-right text-danger">- {{ player.power_transfer_cost }} </td>
                <td></td>
            </tr>
            {% endif %}
            <tr style="border-top: 2px solid #333; font-weight: bold;">
                <td>このラウンドの最終利得</td>
                <td class="text-right">{{ player.payoff }} </td>
                <td></td>
            </tr>
        </table>
        <hr>
        <p style="font-size: 1.2em;">
            あなたの累積利得: <strong>{{ cumulative_payoff }} </strong>
        </p>
    </div>
</div>

<style>
    .punishment-matrix th, .punishment-matrix td {
        font-size: 0.85rem;
        white-space: nowrap;
        padding: 0.5rem 0.75rem;
    }
    .punishment-matrix th {
        font-weight: 600;
    }
</style>
{# ================================================================= #}
{# 第一の表: 貢献と罰の概要                           #}
{# ================================================================= #}
<div class="card mb-3">
    <div class="card-body">
        <h4 class="card-title">ラウンド {{ player.round_number }} のサマリー</h4>
        <table class="table table-bordered text-center punishment-matrix">
            <tbody>
                <tr class="thead-dark">
                    <th></th>
                    {% for summary in players_summary %}
                        <th>{% if summary.id_in_group == player.id_in_group %}あなた{% else %}プレイヤー {{ summary.id_in_group }}{% endif %}</th>
                    {% endfor %}
                </tr>
                {% if show_power_transfer %}
                <tr>
                    <td><strong>罰威力</strong></td>
                    {% for summary in players_summary %}
                        <td>{% if summary.id_in_group == player.id_in_group %}<strong>{{ summary.power_after_display }} / 1.0</strong>{% else %}{{ summary.power_after_display }} / 1.0{% endif %}</td>
                    {% endfor %}
                </tr>
                <tr>
                    <td><strong>転出 / 転入</strong></td>
                    {% for summary in players_summary %}
                        <td>{% if summary.id_in_group == player.id_in_group %}<strong>- {{ summary.power_transfer_out_display }} / + {{ summary.power_transfer_in_display }}</strong>{% else %}- {{ summary.power_transfer_out_display }} / + {{ summary.power_transfer_in_display }}{% endif %}</td>
                    {% endfor %}
                </tr>
                {% if player.session.config.costly_punishment_transfer %}
                <tr>
                    <td><strong>移転コスト</strong></td>
                    {% for summary in players_summary %}
                        <td>{% if summary.id_in_group == player.id_in_group %}<strong>{{ summary.power_transfer_cost }}</strong>{% else %}{{ summary.power_transfer_cost }}{% endif %}</td>
                    {% endfor %}
                </tr>
                {% endif %}
                {% endif %}
                <tr>
                    <td><strong>本回合貢献金額</strong></td>
                    {% for summary in players_summary %}
                        <td>{% if summary.id_in_group == player.id_in_group %}<strong>{{ summary.contribution }} / {{ summary.available_before_contribution }}</strong>{% else %}{{ summary.contribution }} / {{ summary.available_before_contribution }}{% endif %}</td>
                    {% endfor %}
                </tr>
                <tr>
                    <td><strong>本回合消費懲罰点</strong></td>
                    {% for summary in players_summary %}
                        <td>{% if summary.id_in_group == player.id_in_group %}<strong>{{ summary.punishment_sent_total }} / {{ deduction_points }}</strong>{% else %}{{ summary.punishment_sent_total }} / {{ deduction_points }}{% endif %}</td>
                    {% endfor %}
                </tr>
                <tr>
                    <td><strong>本回合受けた罰（合計）</strong></td>
                    {% for summary in players_summary %}
                        <td>{% if summary.id_in_group == player.id_in_group %}<strong>{{ summary.punishment_received_total }}</strong>{% else %}{{ summary.punishment_received_total }}{% endif %}</td>
                    {% endfor %}
                </tr>
            </tbody>
        </table>
    </div>
</div>

{# ================================================================= #}
{# 第三の表: 画像で指定された罰のマトリクス                        #}
{# ================================================================= #}
<div class="card">
    <div class="card-body">
        <h4 class="card-title">罰の交換マトリックス</h4>
        <table class="table table-bordered text-center punishment-matrix">
            <thead class="thead-dark">
                <tr>
                    <th> </th>
                    {% for giver_id in matrix_headers %}
                        <th>{% if giver_id == player.id_in_group %}あなた{% else %}プレイヤー {{ giver_id }}{% endif %} からの罰</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for matrix_row in matrix_rows %}
                <tr class="{% if matrix_row.victim_id == player.id_in_group %}table-primary{% endif %}">
                    <td><strong>{% if matrix_row.victim_id == player.id_in_group %}あなた{% else %}プレイヤー {{ matrix_row.victim_id }}{% endif %}</strong></td>
                    {% for cell in matrix_row.cells %}
                        <td>{% if cell.is_self %}-{% else %}{{ cell.amount }}{% endif %}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="text-right mt-3">
    {% next_button %}
</div>

{# oTree のテンプレートタグで Python の値を JS に渡す #}
{% block internal_scripts %}
    <script>
        // A helper to sum a list of numbers, as there is no built-in filter
        function sum_list(list) {
            if (!Array.isArray(list)) return 0;
            return list.reduce((a, b) => a + (b || 0), 0);
        }
        
        // Register custom filters if supported
        if (typeof otree !== 'undefined' && otree.api && typeof otree.api.setTemplateFilters === 'function') {
            otree.api.setTemplateFilters({
                sum_list: sum_list
            });
        } else {
            console.warn('Custom JS template filters are not supported in this oTree version.');
        }
    </script>
{% endblock %}

{% endblock %}
