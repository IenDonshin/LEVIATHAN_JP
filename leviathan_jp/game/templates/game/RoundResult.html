{% extends "global/Page.html" %}
{% load otree static %}

{% block title %}
    ラウンド結果
{% endblock %}

{% block content %}

<div class="stage-layout">
    <div class="stage-header">
        <div>
            <div class="stage-title">ラウンド概要</div>
            <div class="stage-subtitle">第 {{ player.round_number }} ラウンド</div>
        </div>
        <div class="stage-desc">
            このラウンドの貢献・罰ポイント・損失の概要です。<br>
            あなたの累積利得は {{ cumulative_payoff }} です。
        </div>
    </div>

    <div class="stage-center">
        <div class="stage-stack" style="width: 100%; gap: 2rem;">
            <div class="action-row">
                <div class="summary-chip">貢献段階利得: {{ payoff_from_contribution }}</div>
                <div class="summary-chip">与えた罰コスト: {{ player.punishment_given }}</div>
                <div class="summary-chip">受けた罰損失: {{ player.punishment_received }}</div>
                {% if show_power_transfer and player.session.config.costly_punishment_transfer %}
                <div class="summary-chip">移譲コスト: {{ player.power_transfer_cost }}</div>
                {% endif %}
                <div class="summary-chip">このラウンド利得: {{ player.payoff }}</div>
            </div>

            <div class="player-grid" style="gap: 2.2rem;">
                {% for summary in players_summary %}
                <div class="player-card player-card--wide" style="--idx: {{ forloop.counter0 }};">
                    <div class="player-label">
                        {% if summary.id_in_group == player.id_in_group %}
                            <strong>あなた（プレイヤー {{ summary.id_in_group }}）</strong>
                        {% else %}
                            プレイヤー {{ summary.id_in_group }}
                        {% endif %}
                    </div>
                    <div class="bar-track" data-value="{{ summary.contribution }}" data-max="{{ summary.available_before_contribution }}">
                        <div class="bar-fill"></div>
                        <span class="bar-text">貢献 {{ summary.contribution }} / {{ summary.available_before_contribution }}</span>
                    </div>
                    <div class="bar-track bar-track--warn" style="margin-top: 0.6rem;" data-value="{{ summary.punishment_sent_total }}" data-max="{{ deduction_points }}">
                        <div class="bar-fill"></div>
                        <span class="bar-text">罰ポイント {{ summary.punishment_sent_total }} / {{ deduction_points }}</span>
                    </div>
                    <div class="matrix-note" style="margin-top: 0.6rem;">受けた罰: {{ summary.punishment_received_total }}</div>
                    {% if show_power_transfer %}
                    <div class="matrix-note">罰威力: {{ summary.power_after_display }} / 1.0</div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>

            <div style="width: 100%;">
                <div class="stage-title" style="font-size: 0.95rem; margin-bottom: 0.6rem;">罰の交換マトリクス</div>
                <table class="matrix-table">
                    <thead>
                        <tr>
                            <th></th>
                            {% for giver_id in matrix_headers %}
                                <th>{% if giver_id == player.id_in_group %}あなた{% else %}プレイヤー {{ giver_id }}{% endif %} から</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for matrix_row in matrix_rows %}
                        <tr>
                            <td class="matrix-note"><strong>{% if matrix_row.victim_id == player.id_in_group %}あなた{% else %}プレイヤー {{ matrix_row.victim_id }}{% endif %}</strong></td>
                            {% for cell in matrix_row.cells %}
                                <td class="{% if cell.is_self %}is-self{% endif %}">{% if cell.is_self %}-{% else %}{{ cell.amount }}{% endif %}</td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="stage-footer">
        {% next_button %}
    </div>
</div>

{% endblock %}
